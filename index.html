<!DOCTYPE html>
<html lang="ko">
<head>
<!-- BUILD:v4.4.5 moved stats to í†µê³„ only + SOAP Progress Notes -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ì›°ë‹ˆìŠ¤ ì°¨íŠ¸ â€” ì¸¡ì •/í†µê³„ Â· SOAP ì§„í–‰ë…¸íŠ¸ Â· v4.4.5</title>

<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì›í•˜ë©´ ë¡œì»¬ ë²ˆë“¤ë¡œ êµì²´ ê°€ëŠ¥) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{--bg:#F8F4ED;--text:#2F2F2F;--accent:#00B2A9;--hi:#CDE000;--muted:#6c757d;--card:#fff;--border:#e9ecef;--soft:#f8f9fa;}
*{box-sizing:border-box}
html,body{height:100%}
html{scroll-behavior:smooth;}
body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
.header{display:flex;gap:16px;align-items:center;max-width:1200px;margin:24px auto 0;padding:16px 24px;background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;border-radius:16px}
.logo{width:40px;height:40px;border-radius:8px;background-color:#fff;padding:6px;border:1px solid rgba(255,255,255,.3);box-shadow:0 2px 8px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;font-weight:bold;color:#4facfe;}
.title h1{margin:0;font-size:1.4rem}
.title p{margin:4px 0 0;opacity:.9}
main{max-width:1200px;margin:16px auto;padding:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:24px;margin-bottom:16px;border:1px solid var(--border)}
.hidden{display:none!important}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
@media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
.form-group{display:flex;flex-direction:column;gap:8px}
label{font-weight:600}
input,select,textarea{border:2px solid var(--border);border-radius:10px;padding:12px;font-size:1rem;background:#fff}
input:focus,select:focus,textarea:focus{outline:none;border-color:#4facfe}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;justify-content:center}
.btn{border:none;border-radius:999px;padding:12px 20px;background:var(--soft);cursor:pointer;font-weight:700;transition:transform .2s}
.btn:hover{transform:translateY(-1px)}
.btn-primary{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff}
.btn-secondary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.btn-success{background:linear-gradient(135deg,#00b894,#00a085);color:#fff}
.btn-warning{background:linear-gradient(135deg,#e17055,#d63031);color:#fff}
.btn-info{background:linear-gradient(135deg,#00B2A9,#008E86);color:#fff}
.bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:12px;background:var(--soft);border-radius:12px}
.label{color:var(--muted);font-weight:600;margin-right:8px}
.accent{color:#4facfe}
.progress-wrap{display:flex;align-items:center;gap:12px;margin-top:8px}
.progress{flex:1;height:10px;background:#dee2e6;border-radius:6px;overflow:hidden}
.progress>#progressFill{height:100%;width:0;background:linear-gradient(90deg,#4facfe,#00f2fe);transition:width .3s ease}
.muted{color:var(--muted)}
.categories{display:grid;gap:16px}
.category{border:1px solid var(--border);border-radius:12px;overflow:hidden}
.category-header{color:#fff;padding:14px;font-weight:700}
.questions{padding:16px}
.question{margin-bottom:14px;padding:12px;background:var(--soft);border-left:4px solid #4facfe;border-radius:8px}
.question-text{font-weight:600;margin-bottom:10px}
.rating-scale{display:flex;gap:10px;flex-wrap:wrap}
.rating-option{display:flex;align-items:center;gap:4px;padding:8px 12px;border:2px solid var(--border);border-radius:20px;background:#fff;cursor:pointer;transition:all .2s}
.rating-option:hover{border-color:#4facfe}
.rating-option.selected{background:#4facfe;color:#fff;border-color:#4facfe}
.rating-guide{display:flex;justify-content:space-between;margin-top:8px;padding:6px 10px;background:#e3f2fd;border-radius:6px;font-size:.85rem;color:#1976d2}
.category-score{background:#e8f5e8;color:#2e7d32;padding:12px;text-align:center;font-weight:700;border-top:1px solid var(--border)}
.results-header{text-align:center}
.tile{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;padding:16px;border-radius:12px;margin:12px auto;max-width:480px}
.score-xl{font-size:2.2rem;font-weight:800}
.panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
.details{display:grid;gap:10px}
.detail{display:flex;justify-content:space-between;align-items:center;background:var(--soft);padding:10px;border-radius:8px}
.detail strong{color:#495057}
.detail span{color:#4facfe;font-weight:700}
.scores-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.score-card{background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:14px}
.score-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.score-title{font-weight:600;font-size:.9rem}
.score-number{background:#e9ecef;padding:8px 12px;border-radius:8px;font-weight:800}
.score-bar{width:100%;height:8px;background:#dee2e6;border-radius:4px;overflow:hidden}
.score-fill{height:100%;transition:width .3s ease}
.footer{max-width:1200px;margin:12px auto 24px;padding:8px 16px;color:#fff;display:flex;justify-content:space-between;align-items:center}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* ë¡œê·¸ì¸ ì¹´ë“œ */
#loginSection.card{max-width:420px;margin:40px auto;padding:28px 24px;background:#fff;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
#loginSection .section-title{text-align:center;margin-bottom:24px;font-size:1.5rem;font-weight:700;color:#333}
#loginSection details{margin-top:16px;border:1px solid var(--border);border-radius:8px;padding:12px}
#loginSection details summary{cursor:pointer;font-weight:600;padding:8px}

/* ìƒë‹¨ ë„¤ë¹„ */
.topnav{max-width:1200px;margin:10px auto 0;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;background:var(--soft);border:1px solid var(--border);border-radius:12px;position:sticky;top:10px;z-index:100}
.topnav .nav-left,.topnav .nav-right{display:flex;gap:8px;flex-wrap:wrap}

/* í”Œë¡œíŒ… ì§„í–‰ë¥  */
.floating-progress{position:fixed;top:20px;right:20px;z-index:1000;background:rgba(255,255,255,.95);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);backdrop-filter:blur(10px)}
.progress-circle{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:conic-gradient(#4facfe 0deg,#e9ecef 0deg);margin:0 auto 8px}
.progress-number{font-size:12px;font-weight:700;color:#333}
.progress-label{text-align:center;font-size:11px;color:#666;font-weight:600}
@media (max-width:768px){.floating-progress{top:10px;right:10px;padding:8px}.progress-circle{width:40px;height:40px}.rating-scale{justify-content:center}.rating-option{min-width:40px;justify-content:center}}

/* í”„ë¦°íŠ¸ */
@media print{ @page{size:A4 portrait;margin:10mm} body{background:#fff!important} .header,.footer,.actions,.topnav,.floating-progress,.debug-info{display:none!important} .card{box-shadow:none;border:1px solid #ccc;} }

/* ë””ë²„ê·¸ */
.debug-info{position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:8px;border-radius:4px;font-size:12px;z-index:1001;max-width:300px}

#resultsSection.hidden #baselineBar{display:none!important}

/* ë¡œê·¸ì¸ ë·°ì—ì„œ ê²°ê³¼/ì§„í–‰ UI ê°•ì œ ë¹„í‘œì‹œ */
body[data-view="login"] #topNav,
body[data-view="login"] #baselineBar,
body[data-view="login"] #progressSection,
body[data-view="login"] #resultsSection,
body[data-view="login"] .baseline-dropdown {
  display: none !important;
}

/* SOAP Notes ìŠ¤íƒ€ì¼ */
.soap-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:2px solid var(--border)}
.soap-tab{padding:12px 24px;border:none;background:transparent;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;transition:all .2s}
.soap-tab.active{color:#4facfe;border-bottom-color:#4facfe}
.soap-content{min-height:200px}
.soap-section{display:none}
.soap-section.active{display:block}
.soap-textarea{width:100%;min-height:150px;border:2px solid var(--border);border-radius:10px;padding:16px;font-size:1rem;font-family:inherit;resize:vertical}
.note-card{background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.note-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.note-date{font-weight:600;color:#4facfe}
.note-actions{display:flex;gap:8px}
.note-content{white-space:pre-wrap;line-height:1.6}
.soap-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
.soap-summary-item{background:var(--soft);border-left:4px solid #4facfe;padding:12px;border-radius:8px}
.soap-summary-title{font-weight:600;color:#4facfe;font-size:.9rem}
.template-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.template-btn{padding:6px 12px;border:1px solid var(--border);border-radius:20px;background:var(--soft);cursor:pointer;font-size:.85rem;transition:all .2s}
.template-btn:hover{background:#4facfe;color:#fff}

/* ì‹ ì²´ ì •ë³´ í•„ë“œ ì •ë ¬ ìˆ˜ì • */
.vitals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;align-items:end}
@media (max-width:768px){.vitals-grid{grid-template-columns:1fr}}

</style>
</head>
<body>
<header class="header" role="banner">
  <div class="logo">W</div>
  <div class="title">
    <h1>ì˜¤ ì›°ë‹ˆìŠ¤ ì²´í¬ ì‹œìŠ¤í…œ</h1>
    <p>12ê°œ ì¹´í…Œê³ ë¦¬ ì¢…í•© í‰ê°€ Â· ë ˆì´ë” ì°¨íŠ¸ Â· íšŒì›ë³„ ì¶”ì´ Â· SOAP ì§„í–‰ë…¸íŠ¸ Â· v4.4.5</p>
  </div>
</header>

<nav class="topnav hidden" id="topNav" aria-label="ì£¼ìš” ë©”ë‰´">
  <div class="nav-left">
    <button class="btn btn-secondary" onclick="navTo('measurement')">ì¸¡ì •</button>
    <button class="btn btn-secondary" id="progressNav" onclick="navTo('progress')">í†µê³„</button>
    <button class="btn btn-secondary" onclick="navTo('notes')">ì§„í–‰ë…¸íŠ¸</button>
 <div class="nav-right">
  <!-- íŒŒë€ìƒ‰ -->
  <button class="btn btn-primary" onclick="downloadCombinedResults()">ê²°ê³¼ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>

  <!-- í‹°ì–¼ìƒ‰ -->
  <button class="btn btn-info" onclick="exportData()">JSON ë‚´ë³´ë‚´ê¸°</button>

  <!-- ì´ˆë¡ìƒ‰  -->
  <button class="btn btn-success" onclick="exportCSVMenu()">CSV ë‚´ë³´ë‚´ê¸°</button>

  <!-- ì£¼í™©ìƒ‰ -->
  <button class="btn btn-warning" onclick="triggerCSVImport()">CSV ê°€ì ¸ì˜¤ê¸°</button>

  <input id="csvInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleCSVFile(this.files[0])"/>
  <button class="btn btn-warning" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</nav>

<main>
  <!-- ë¡œê·¸ì¸ -->
  <section class="card" id="loginSection">
    <div class="panel">
      <h2 class="section-title">ì½”ì¹˜ ë¡œê·¸ì¸</h2>
      <div class="form-group">
        <label for="loginCoachName">ì½”ì¹˜ ì´ë¦„</label>
        <input id="loginCoachName" placeholder="ì˜ˆ) í™ê¸¸ë™" type="text"/>
      </div>
      <div class="form-group">
        <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
        <input id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password"/>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      </div>

      <details>
        <summary><strong>ì‹ ê·œ ì½”ì¹˜ ë“±ë¡</strong></summary>
        <div class="form-group"><label for="registerCoachName">ì½”ì¹˜ ì´ë¦„</label><input id="registerCoachName" type="text"/></div>
        <div class="form-group"><label for="registerPassword">ë¹„ë°€ë²ˆí˜¸</label><input id="registerPassword" type="password"/></div>
        <div class="form-group"><label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="confirmPassword" type="password"/></div>
        <div class="actions"><button class="btn btn-success" onclick="handleRegister()">ë“±ë¡</button></div>
      </details>
      <p class="muted" style="margin-top:8px">íŒ: ì½”ì¹˜ ì´ë¦„ì„ <strong>master</strong>ë¡œ ë“±ë¡/ë¡œê·¸ì¸í•˜ë©´ ëª¨ë“  ì½”ì¹˜ ë°ì´í„°ë¥¼ ëŒ€ì‹œë³´ë“œì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
  </section>

  <!-- SOAP ì§„í–‰ë…¸íŠ¸ ì„¹ì…˜ -->
  <section class="card hidden" id="notesSection">
    <div class="bar">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div><span class="label">ì½”ì¹˜</span> <strong class="accent" id="notesCoachLabel">-</strong></div>
        <div><span class="label">íšŒì›</span> <strong class="accent" id="notesClientLabel">ì„ íƒí•˜ì„¸ìš”</strong></div>
      </div>
      <div class="actions" style="margin:0">
        <input id="notesClientSearch" list="notesClientList" placeholder="íšŒì› ì´ë¦„ ê²€ìƒ‰" oninput="renderNotes(this.value)"/>
        <datalist id="notesClientList"></datalist>
      </div>
    </div>

    <!-- ìƒˆ SOAP ë…¸íŠ¸ ì‘ì„± -->
    <div class="panel" id="soapWritePanel">
      <h3>ìƒˆ ì§„í–‰ë…¸íŠ¸ ì‘ì„± (SOAP)</h3>
      
      <!-- SOAP íƒ­ -->
      <div class="soap-tabs">
        <button class="soap-tab active" onclick="switchSoapTab('subjective')">S - ì£¼ê´€ì </button>
        <button class="soap-tab" onclick="switchSoapTab('objective')">O - ê°ê´€ì </button>
        <button class="soap-tab" onclick="switchSoapTab('assessment')">A - í‰ê°€</button>
        <button class="soap-tab" onclick="switchSoapTab('plan')">P - ê³„íš</button>
      </div>

      <div class="soap-content">
        <!-- Subjective -->
        <div class="soap-section active" id="subjective-section">
          <div class="template-buttons">
            <button class="template-btn" onclick="addTemplate('subjective', '- í”¼ë¡œê° ì¦ê°€\n- ìˆ˜ë©´ ì§ˆ ì €í•˜\n- ì‹ìš• ë³€í™”')">ì¼ë°˜ ì¦ìƒ</button>
            <button class="template-btn" onclick="addTemplate('subjective', '- ìš´ë™ ì‹œ ìˆ¨ì°¬ ì¦ìƒ\n- ê´€ì ˆ í†µì¦\n- ê·¼ìœ¡ ê²½ì§ê°')">ìš´ë™ ê´€ë ¨</button>
            <button class="template-btn" onclick="addTemplate('subjective', '- ëª©í‘œ: ì²´ì¤‘ 5kg ê°ëŸ‰\n- ìš°ì„ ìˆœìœ„: ê·¼ë ¥ í–¥ìƒ\n- ê´€ì‹¬ì‚¬: ê· í˜• ì¡íŒ ì‹ë‹¨')">ëª©í‘œ</button>
          </div>
          <textarea class="soap-textarea" id="subjectiveText" placeholder="íšŒì›ì´ í˜¸ì†Œí•˜ëŠ” ì£¼ê´€ì  ì¦ìƒ, ëª©í‘œ, ìƒíƒœë¥¼ ê¸°ë¡í•˜ì„¸ìš”...&#10;ì˜ˆ: ìµœê·¼ í—ˆë¦¬ í†µì¦ì´ ì‹¬í•´ì¡Œë‹¤ê³  í•¨, ì²´ì¤‘ ê°ëŸ‰ ëª©í‘œ, ìš´ë™ ì˜ìš• ì¦ê°€"></textarea>
        </div>

        <!-- Objective -->
        <div class="soap-section" id="objective-section">
          <div class="template-buttons">
            <button class="template-btn" onclick="loadObjectiveData()">ì¸¡ì • ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="template-btn" onclick="addTemplate('objective', 'ì²´ì¤‘: kg\ní˜ˆì••: mmHg\nì‹¬ë°•ìˆ˜: bpm\nì²´ì§€ë°©ë¥ : %')">ê¸°ë³¸ ìˆ˜ì¹˜</button>
            <button class="template-btn" onclick="addTemplate('objective', 'ìš´ë™ëŸ‰: ë¶„/ì£¼\nê·¼ë ¥ í…ŒìŠ¤íŠ¸: \nìœ ì—°ì„± í‰ê°€: \nê· í˜•ê°ê°: ')">ìš´ë™ í‰ê°€</button>
          </div>
          <textarea class="soap-textarea" id="objectiveText" placeholder="ì¸¡ì •ëœ ê°ê´€ì  ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ì„¸ìš”...&#10;ì˜ˆ: BMI 24.5, RHR 68bpm, ì›°ë‹ˆìŠ¤ ì ìˆ˜ 220/300, ìŠ¤ì¿¼íŠ¸ 15íšŒ ê°€ëŠ¥"></textarea>
        </div>

        <!-- Assessment -->
        <div class="soap-section" id="assessment-section">
          <div class="template-buttons">
            <button class="template-btn" onclick="addTemplate('assessment', 'ê°œì„ ì‚¬í•­:\n- \n\nìš°ë ¤ì‚¬í•­:\n- \n\nì „ë°˜ì  ìƒíƒœ: ')">ì¢…í•© í‰ê°€</button>
            <button class="template-btn" onclick="addTemplate('assessment', 'ê°•ì :\n- \n\nì•½ì :\n- \n\nìœ„í—˜ìš”ì†Œ:\n- ')">ê°•ì•½ì  ë¶„ì„</button>
            <button class="template-btn" onclick="addTemplate('assessment', 'ì´ì „ ëŒ€ë¹„ ë³€í™”:\n- ê°œì„ : \n- ì •ì²´: \n- ì•…í™”: ')">ì§„ì „ë„ í‰ê°€</button>
          </div>
          <textarea class="soap-textarea" id="assessmentText" placeholder="ì½”ì¹˜ì˜ ì „ë¬¸ì  í‰ê°€ì™€ ë¶„ì„ì„ ê¸°ë¡í•˜ì„¸ìš”...&#10;ì˜ˆ: ì „ë°˜ì ì¸ ì²´ë ¥ í–¥ìƒ, í•˜ì§€ë§Œ ì‹¬í˜ˆê´€ ì§€êµ¬ë ¥ ë¶€ì¡±, ì‹ìŠµê´€ ê°œì„  í•„ìš”"></textarea>
        </div>

        <!-- Plan -->
        <div class="soap-section" id="plan-section">
          <div class="template-buttons">
            <button class="template-btn" onclick="addTemplate('plan', 'ë‹¨ê¸° ëª©í‘œ (1-2ì£¼):\n- \n\nì¤‘ê¸° ëª©í‘œ (1-3ê°œì›”):\n- \n\nì¥ê¸° ëª©í‘œ (6ê°œì›”+):\n- ')">ëª©í‘œ ì„¤ì •</button>
            <button class="template-btn" onclick="addTemplate('plan', 'ìš´ë™ ê³„íš:\n- ë¹ˆë„: ì£¼ íšŒ\n- ê°•ë„: \n- ì¢…ë¥˜: \n\nì˜ì–‘ ê³„íš:\n- \n\nìƒí™œìŠµê´€:\n- ')">ìƒì„¸ ê³„íš</button>
            <button class="template-btn" onclick="addTemplate('plan', 'ë‹¤ìŒ í‰ê°€ì¼: \níŠ¹ë³„ ì£¼ì˜ì‚¬í•­: \nì¶”ì²œ ì „ë¬¸ì˜ ìƒë‹´: \nê¸°íƒ€: ')">í›„ì† ì¡°ì¹˜</button>
          </div>
          <textarea class="soap-textarea" id="planText" placeholder="í–¥í›„ ìš´ë™ ê³„íš, ìƒí™œìŠµê´€ ê°œì„ ì•ˆ, ì¬í‰ê°€ ì¼ì • ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”...&#10;ì˜ˆ: ì£¼ 3íšŒ ìœ ì‚°ì†Œ ìš´ë™, ë‹¨ë°±ì§ˆ ì„­ì·¨ ì¦ê°€, 2ì£¼ í›„ ì¬í‰ê°€"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-success" onclick="saveSoapNoteUI()">ì§„í–‰ë…¸íŠ¸ ì €ì¥</button>
        <button class="btn" onclick="clearSoapForm()">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- SOAP ë…¸íŠ¸ ëª©ë¡ -->
    <div class="panel">
      <h3>ì§„í–‰ë…¸íŠ¸ íˆìŠ¤í† ë¦¬</h3>
      <div id="soapNotesList"></div>
    </div>
  </section>

  <!-- ì§„í–‰(í†µê³„) ì „ìš© ì„¹ì…˜: v4.4.4 ì´ë™ -->
  <section class="card hidden" id="progressSection">

    <div class="bar">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div><span class="label">ì½”ì¹˜</span> <strong class="accent" id="progressCoachLabel">-</strong></div>
        <div><span class="label">íšŒì›</span> <strong class="accent" id="progressClientLabel">ì„ íƒí•˜ì„¸ìš”</strong></div>
      </div>
      <div class="actions" style="margin:0">
        <input id="progressClientSearch" list="progressClientList" placeholder="íšŒì› ì´ë¦„ ê²€ìƒ‰" oninput="renderProgress(this.value)"/>
        <datalist id="progressClientList"></datalist>
      </div>
    </div>

    <div class="bar">
      <div class="label">í•„í„°</div>
      <div class="actions" style="margin:0">
        <button class="btn" onclick="setProgressRange(7)">ìµœê·¼ 7ì¼</button>
        <button class="btn" onclick="setProgressRange(30)">ìµœê·¼ 30ì¼</button>
        <button class="btn" onclick="setProgressRange(90)">ìµœê·¼ 90ì¼</button>
        <label class="rating-option" style="margin-left:8px">
          <input type="checkbox" id="ma3" onchange="renderProgress(currentProgressClient)"/>
          <span>3íšŒ ì´ë™í‰ê· </span>
        </label>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <h3>ì ìˆ˜ ë³€í™” ì¶”ì´</h3>
        <div style="position:relative;height:280px"><canvas id="totalTrendChart"></canvas></div>
      </div>
      <div class="panel">
        <h3>ìµœì‹  ì¹´í…Œê³ ë¦¬ ì ìˆ˜</h3>
        <div style="position:relative;height:280px"><canvas id="latestCategoryChart"></canvas></div>
      </div>
    </div>

    <div class="panel">
      <h3>ì¸¡ì • í†µê³„</h3>
      <div class="details" id="progressStats"></div>
    </div>

    <div class="panel">
      <h3>ì¸¡ì • íˆìŠ¤í† ë¦¬</h3>
      <table class="table" style="width:100%;border-collapse:separate;border-spacing:0 8px">
        <thead><tr><th>ë‚ ì§œ</th><th>ì ìˆ˜</th><th>ì²´ì¤‘(kg)</th><th>RHR(bpm)</th><th>ë©”ëª¨</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
  
    <div class="panel">
      <h3>íšŒì› ìŠ¤íŒŒí¬ë¼ì¸ (ìµœê·¼ 8íšŒ)</h3>
      <div id="sparklineWrap" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
    </div>

    <div class="panel hidden" id="importPreviewPanel" aria-live="polite">
      <h3>CSV ë¯¸ë¦¬ë³´ê¸°</h3>
      <div id="importPreview" class="details"></div>
      <div class="actions">
        <button class="btn btn-success" onclick="confirmImportCSV()">ë³µì› ì €ì¥</button>
        <button class="btn btn-warning" onclick="cancelImportCSV()">ì·¨ì†Œ</button>
      </div>
    </div>
  
  </section>


  <section class="card hidden" id="infoSection">
    <!-- v4.4.4: í†µê³„ ëŒ€ì‹œë³´ë“œëŠ” #progressSectionìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤. -->
  </section>

  <!-- í‰ê°€ ì„¹ì…˜ -->
  <section class="card hidden" id="assessmentSection">
    <div class="bar">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div><span class="label">ì½”ì¹˜</span> <strong class="accent" id="currentCoachName">-</strong></div>
        <div><span class="label">ì¸¡ì •ì¼</span> <input type="date" id="measurementDate" style="border:none;background:transparent;color:#4facfe;font-weight:700"/></div>
      </div>
      <div class="actions" style="margin:0">
        <button class="btn btn-success" onclick="handleSave()">ì €ì¥</button>
        <button class="btn btn-warning" onclick="resetAll()">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <h3>ê¸°ë³¸ ì •ë³´</h3>
        <div class="grid-2">
          <div class="form-group">
            <label for="clientName">íšŒì› ì´ë¦„</label>
            <input id="clientName" placeholder="í™ê¸¸ë™" list="clientSuggestions" oninput="handleClientTyping(this.value)"/>
            <datalist id="clientSuggestions"></datalist>
          </div>
          <div class="form-group">
            <label for="memberNumber">íšŒì›ë²ˆí˜¸</label>
            <input id="memberNumber" placeholder="12345"/>
          </div>
        </div>
        <div class="grid-3">
          <div class="form-group">
            <label for="gender">ì„±ë³„</label>
            <select id="gender"><option value="">ì„ íƒ</option><option value="ë‚¨ì„±">ë‚¨ì„±</option><option value="ì—¬ì„±">ì—¬ì„±</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select>
          </div>
          <div class="form-group">
            <label for="age">ë‚˜ì´</label>
            <input id="age" type="number" placeholder="25" min="1" max="120"/>
          </div>
          <div class="form-group">
            <label for="phone">ì „í™”ë²ˆí˜¸</label>
            <input id="phone" placeholder="010-1234-5678"/>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3>ì‹ ì²´ ì •ë³´</h3>
        <div class="vitals-grid">
          <div class="form-group">
            <label for="heightCm">í‚¤ (cm)</label>
            <input id="heightCm" type="number" placeholder="170" min="100" max="250"/>
          </div>
          <div class="form-group">
            <label for="weightKg">ì²´ì¤‘ (kg)</label>
            <input id="weightKg" type="number" placeholder="70" min="20" max="200" step="0.1"/>
          </div>
          <div class="form-group">
            <label for="rhr">ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜ (bpm)</label>
            <input id="rhr" type="number" placeholder="60" min="30" max="150"/>
          </div>
        </div>
        <div class="form-group">
          <label for="goalNote">ëª©í‘œ/ë©”ëª¨</label>
          <input id="goalNote" placeholder="ê±´ê°•í•œ ì²´ì¤‘ ê°ëŸ‰, ê·¼ë ¥ í–¥ìƒ ë“±"/>
        </div>
      </div>
    </div>

    <!-- ëª©í‘œ/ë©”ëª¨ ì „ìš© íŒ¨ë„ (ê¸°ë³¸/ì‹ ì²´ ì •ë³´ ì•„ë˜) -->
    <div class="panel" id="goalMemoPanel">
      <h3>ëª©í‘œ/ë©”ëª¨</h3>
      <div class="form-group">
        <label for="goalMemo">íšŒì› ëª©í‘œ / ì½”ì¹˜ ë©”ëª¨</label>
        <textarea id="goalMemo" rows="4" placeholder="ì˜ˆ) ì²´ì§€ë°© 3kg ê°ëŸ‰, ì£¼ 2íšŒ ê·¼ë ¥, ìœ ì‚°ì†Œ 150ë¶„, ìˆ˜ë©´ ë£¨í‹´ ê°œì„ " style="width:100%;border:2px solid var(--border);border-radius:10px;padding:12px;font-size:1rem;"></textarea>
      </div>
    </div>

    <!-- ì‹ ì²´ ì •ë³´ ì‹œê°í™” (BMI / ì‹¬ë°•ìˆ˜ Zone) -->
    <div class="panel" id="vitalsPanel">
      <h3>ì‹ ì²´ ì§€í‘œ ì‹œê°í™”</h3>
      <div class="grid-2">
        <!-- BMI ì¹´ë“œ -->
        <div class="score-card">
          <div class="score-header">
            <div class="score-title">BMI</div>
            <div class="score-number" id="bmiValue">-</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px" class="muted">
            <span>ì €ì²´ì¤‘&lt;18.5</span><span>Â·</span><span>ì •ìƒ 18.5â€”24.9</span><span>Â·</span><span>ê³¼ì²´ì¤‘ 25â€”29.9</span><span>Â·</span><span>ë¹„ë§Œ â‰¥30</span>
          </div>
          <div class="score-bar" style="position:relative;height:10px;">
            <div style="display:flex;width:100%;height:100%;">
              <div style="flex:18.5;background:#cfe8ff"></div>
              <div style="flex:6.5;background:#b8f2e6"></div>
              <div style="flex:5.0;background:#ffe08a"></div>
              <div style="flex:10;background:#ffc9c9"></div>
            </div>
            <div id="bmiMarker" style="position:absolute;top:-3px;left:0;width:0;height:16px;border-left:3px solid #4facfe;"></div>
          </div>
          <div class="muted" id="bmiCategory" style="margin-top:6px">-</div>
        </div>

        <!-- Heart Rate Zones ì¹´ë“œ -->
        <div class="score-card">
          <div class="score-header">
            <div class="score-title">ì‹¬ë°•ìˆ˜ Zones (HRR ê¸°ë°˜)</div>
            <div class="score-number" id="mhrRhrLabel">-</div>
          </div>
          <div class="muted" style="margin-bottom:8px">Zone1 50â€”60% Â· Zone2 60â€”70% Â· Zone3 70â€”80%</div>
          <div id="zoneBar" style="display:flex;width:100%;height:10px;border-radius:4px;overflow:hidden;background:#dee2e6">
            <div id="zone1Seg" style="width:33.333%;background:#d0ebff"></div>
            <div id="zone2Seg" style="width:33.333%;background:#b2f2bb"></div>
            <div id="zone3Seg" style="width:33.333%;background:#ffe8a1"></div>
          </div>
          <div class="details" style="margin-top:8px">
            <div class="detail"><strong>Zone 1</strong><span id="z1Range">-</span></div>
            <div class="detail"><strong>Zone 2</strong><span id="z2Range">-</span></div>
            <div class="detail"><strong>Zone 3</strong><span id="z3Range">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel"><h3>ì›°ë‹ˆìŠ¤ í‰ê°€</h3>
      <div class="progress-wrap">
        <div class="progress"><div id="progressFill"></div></div>
        <div id="progressText" class="muted">ì‘ë‹µë¥  0%</div>
      </div>
      <div class="categories" id="categoriesContainer"></div>
    </div>
  </section>

  <!-- ê²°ê³¼ ì„¹ì…˜ -->
  <section class="card hidden" id="resultsSection">
    <div class="results-header">
      <div class="tile">
        <div class="score-xl" id="finalTotalScore">0/300</div>
        <div>ì´ ì›°ë‹ˆìŠ¤ ì ìˆ˜</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel" id="resultRadarPanel">
        <h3>ë ˆì´ë” ì°¨íŠ¸</h3>
        <div style="position:relative;height:320px"><canvas id="radarChart"></canvas></div>
      </div>
      <div class="panel" id="resultInfoPanel">
        <h3>ì¸¡ì • ì •ë³´</h3>
        <div class="details" id="clientDetails"></div>
      </div>
    </div>

    <div class="panel" id="resultCategoryPanel">
      <h3>ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ì ìˆ˜</h3>
      <div class="scores-grid" id="scoresList"></div>
    </div>

    <div class="panel" id="resultsTrendPanel">
      <h3>ê°œì¸ ì ìˆ˜ ì¶”ì´ (ìµœê·¼ 8íšŒ)</h3>
      <div style="position:relative;height:280px"><canvas id="miniTrendChart"></canvas></div>
      
      <!-- ì¸¡ì • í™”ë©´ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 12px; border: 1px solid #e1bee7;">
        <div class="actions" style="justify-content: center; flex-wrap: wrap; gap: 12px; margin: 0;">
          <button class="btn btn-secondary" onclick="navTo('progress')" style="min-width: 100px;">
            ğŸ“ˆ ìƒì„¸ ë¶„ì„
          </button>
          <button class="btn btn-secondary" onclick="navTo('notes')" style="min-width: 100px;">
            ğŸ“ ì§„í–‰ë…¸íŠ¸
          </button>
          <button class="btn btn-primary" onclick="downloadImage()" style="min-width: 100px;">
            ğŸ–¼ï¸ ê²°ê³¼ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          </button>
          <button class="btn btn-success" onclick="exportCSVMenu()" style="min-width: 100px;">
            ğŸ“Š CSV
          </button>
          <button class="btn" onclick="resetAll()" style="min-width: 100px;">
            ğŸ”„ ìƒˆ ì¸¡ì •
          </button>
        </div>
        <p style="text-align: center; margin: 8px 0 0 0; color: #7b1fa2; font-size: 0.85rem;">
          ìƒì„¸í•œ ë³€í™” ì¶”ì´ëŠ” 'ìƒì„¸ ë¶„ì„'ì—ì„œ, ì§„í–‰ë…¸íŠ¸ëŠ” 'ì§„í–‰ë…¸íŠ¸'ì—ì„œ í™•ì¸í•˜ì„¸ìš”
        </p>
      </div>
    </div>
  </section>
</main>

<footer class="footer">
  <small>Â© O! Wellness. ë¡œì»¬ ë¸Œë¼ìš°ì € ì €ì¥(IndexedDB) ì‚¬ìš©. Â· v4.4.5</small>
  <small>made by O!wellness</small>
</footer>

<!-- ë””ë²„ê·¸ (ì„ íƒ í‘œì‹œ) -->
<div class="debug-info" id="debugInfo" style="display:none;">
  <div>DB ìƒíƒœ: <span id="dbStatus">ì´ˆê¸°í™” ì¤‘...</span></div>
  <div>ì•± ìƒíƒœ: <span id="appStatus">ë¡œë”© ì¤‘...</span></div>
  <div>ì˜¤ë¥˜: <span id="errorStatus">ì—†ìŒ</span></div>
</div>

<script>
// ========================
// ìƒìˆ˜ & ì „ì—­
// ========================
const QUESTIONS_PER_CAT=5, MAX_PER_CAT=25;
const DB_NAME='Owellness';
const DB_VERSION=5; // SOAP ë…¸íŠ¸ ì¶”ê°€ë¡œ ë²„ì „ ì—…
let currentCoach=null, currentView='login', _db=null;
let radarChart=null, totalTrendChart=null, latestCategoryChart=null, miniTrendChart=null;

const categories=[
  {
    "name":"ì›€ì§ì„",
    "shortLabel":"ì›€ì§ì„",
    "questions":[
      "ì£¼ 150ë¶„ ì´ìƒ ìœ ì‚°ì†Œ í™œë™ì„ í•œë‹¤.",
      "ì£¼ 2íšŒ ì´ìƒ ê·¼ë ¥ ìš´ë™ì„ í•œë‹¤.",
      "ê· í˜• ìš´ë™ê³¼ ìŠ¤íŠ¸ë ˆì¹­ì˜ ì˜ë¯¸ë¥¼ ì•Œê³  ìˆë‹¤.",
      "ìš´ë™ ì „í›„ ë‚´ ëª¸ì˜ ìƒíƒœ ë³€í™”ë¥¼ í™•ì¸í•œë‹¤.",
      "ì¢Œì‹ ìƒí™œì˜ ìœ í•´í•¨ì„ ì•Œê³  ë§‰ê¸° ìœ„í•´ ë…¸ë ¥í•œë‹¤."
    ],
    "color":"#FF6B6B"
  },
  {
    "name":"ì‹ì‚¬ì™€ ì˜ì–‘",
    "shortLabel":"ì‹ì‚¬ & ì˜ì–‘",
    "questions":[
      "í•˜ë£¨ì— ê³¼ì¼ 4ê°€ì§€ ì´ìƒ, ì±„ì†Œ 5ê°€ì§€ ì´ìƒì„ ë¨¹ëŠ”ë‹¤.",
      "ë‹¨ë°±ì§ˆÂ·íƒ„ìˆ˜í™”ë¬¼Â·ì§€ë°©ì´ ëª¸ì— ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ì•Œê³  ìˆë‹¤.",
      "ë‚´ê°€ ë¨¹ëŠ” ìŒì‹Â·ì œí’ˆì˜ ì˜ì–‘ ì„±ë¶„í‘œë¥¼ í™•ì¸í•œë‹¤.",
      "í•˜ë£¨ ë‘ ë¼ ì´ìƒ ë‹¨ë°±ì§ˆ ì‹í’ˆì„ í¬í•¨í•œë‹¤.",
      "ìŒì‹ì„ ì—°ë£Œë¡œ, ì•½ìœ¼ë¡œ ê·¸ë¦¬ê³  ì¦ê±°ì›€ìœ¼ë¡œ ì—¬ê¸´ë‹¤."
    ],
    "color":"#4ECDC4"
  },
  {
    "name":"ìˆ˜ë©´",
    "shortLabel":"ìˆ˜ë©´",
    "questions":[
      "ë°¤ì— 7â€“9ì‹œê°„ ê·œì¹™ì ìœ¼ë¡œ ì”ë‹¤.",
      "ìˆ˜ë©´ ë¶€ì¡±ê³¼ ìœ„ìƒì´ ê±´ê°•ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì•Œê³  ìˆë‹¤.",
      "ì •ì˜¤ ì´í›„ì—ëŠ” ì¹´í˜ì¸ì„ ë§ˆì‹œì§€ ì•ŠëŠ”ë‹¤.",
      "ìê¸° ì „ 30ë¶„ì€ íœ´ëŒ€í°ì„ ë©€ë¦¬í•œë‹¤.",
      "ì•„ì¹¨ì— ì¼ì–´ë‚¬ì„ ë•Œ ë‚´ ëª¸ì˜ íšŒë³µê°ì„ ì ê²€í•œë‹¤."
    ],
    "color":"#45B7D1"
  },
  {
    "name":"ìŠ¤íŠ¸ë ˆìŠ¤ & íšŒë³µ",
    "shortLabel":"ìŠ¤íŠ¸ë ˆìŠ¤",
    "questions":[
      "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ëª¸ê³¼ ë§ˆìŒì— ë‚˜íƒ€ë‚˜ëŠ” ì‹ í˜¸ë¥¼ ì•Œì•„ì°¨ë¦°ë‹¤.",
      "ìŠ¤íŠ¸ë ˆìŠ¤ ì™„í™” ë°©ë²•ì˜ ì¤‘ìš”ì„±ì„ ì•Œê³  ì‹¤ì²œí•˜ê³  ìˆë‹¤.",
      "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ëª¸ê³¼ ë§ˆìŒì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì•Œê³  ìˆë‹¤.",
      "íšŒë³µê³¼ ì¶©ì „ì„ ìœ„í•œ ê³µê°„ê³¼ ì‹œê°„ì„ ì¶”êµ¬í•œë‹¤.",
      "í•˜ë£¨ì— í•œ ë²ˆ ì´ìƒ ëª¸/ë§ˆìŒì˜ ê¸´ì¥ì„ í’€ê¸° ìœ„í•œ ë£¨í‹´ì„ ì‹¤ì²œí•œë‹¤."
    ],
    "color":"#96CEB4"
  },
  {
    "name":"ê´€ê³„ì„±",
    "shortLabel":"ê´€ê³„",
    "questions":[
      "ë‚˜ë¥¼ ì§€ì§€í•´ì£¼ëŠ” ì‚¬ëŒì´ ëˆ„êµ¬ì¸ì§€ ì•Œê³  ìˆë‹¤.",
      "ê·¸ë£¹ í™œë™(ìš´ë™, ì·¨ë¯¸, ì¢…êµ, ë´‰ì‚¬ ë“±)ì— ì°¸ì—¬í•˜ê³  ìˆë‹¤.",
      "ê±´ì „í•œ ì‚¬íšŒì  ì—°ê²°ì´ ê±´ê°•ì— ì¤‘ìš”í•œ ì´ìœ ë¥¼ ì•Œê³  ìˆë‹¤.",
      "ì£¼ 5íšŒ ì´ìƒ ê°€ì¡±Â·ì§€ì¸ê³¼ ì—°ë½í•˜ê±°ë‚˜ ë§Œë‚œë‹¤.",
      "ë§¤ì¼ ëŒë´„ í™œë™ì„ í•˜ëŠ” ëŒ€ìƒì´ ìˆë‹¤.(ë°˜ë ¤ ë™ë¬¼, ì‹ë¬¼ ë“±)"
    ],
    "color":"#FFEAA7"
  },
  {
    "name":"ëª©í‘œ & ì˜ë¯¸",
    "shortLabel":"ëª©í‘œ & ì˜ë¯¸",
    "questions":[
      "ì—°ê°„Â·ë¶„ê¸° ëª©í‘œë¥¼ ì„¸ìš°ê³  ì ê²€í•œë‹¤.",
      "ë‚´ê°€ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê°€ì¹˜ê°€ ë¬´ì—‡ì¸ì§€ ì•Œê³  ìˆë‹¤.",
      "ëª©í‘œë¥¼ ì„¸ìš°ëŠ” ê²ƒì˜ ê°€ì¹˜ë¥¼ ì•Œê³  ìˆë‹¤.",
      "í•˜ë£¨ ëª©í‘œë¥¼ ì„¸ìš°ê³  í™•ì¸í•œë‹¤.",
      "ë‚´ê°€ í•˜ëŠ” ì¼ì´ ë‚´ ê°€ì¹˜ì™€ ì—°ê²°ëœë‹¤ê³  ëŠë‚€ë‹¤."
    ],
    "color":"#DDA0DD"
  },
  {
    "name":"íƒœë„ & ì—ë„ˆì§€",
    "shortLabel":"íƒœë„ & ì—ë„ˆì§€",
    "questions":[
      "í•˜ë£¨ì— í•œ ë²ˆ ë‚´ê°€ ì˜í•œ ì¼ì„ ë– ì˜¬ë¦°ë‹¤.",
      "í˜ë“  ìˆœê°„ ê¸ì •ì ì¸ ë§ì„ ìŠ¤ìŠ¤ë¡œ í•œë‹¤.",
      "ê¸ì •ì ì¸ íƒœë„ê°€ ê±´ê°•ê³¼ í–‰ë™ ë³€í™”ì— ì£¼ëŠ” ì˜í–¥ì„ ì•Œê³  ìˆë‹¤.",
      "í•˜ë£¨ 30ë¶„ ì´ìƒ ë‚˜ë¥¼ ê¸°ë¶„ ì¢‹ê²Œ í•˜ëŠ” í™œë™ì„ í•œë‹¤.",
      "ì—ë„ˆì§€ë¥¼ ì†Œëª¨í•˜ëŠ” ìŠµê´€ì´ë‚˜ ì‚¬ëŒì„ ì¤„ì¸ë‹¤."
    ],
    "color":"#74B9FF"
  },
  {
    "name":"ì•ˆì „ & ìœ í•´ ìŠµê´€ ì¤„ì´ê¸°",
    "shortLabel":"ì•ˆì „",
    "questions":[
      "í¡ì—°Â·ì „ìë‹´ë°°ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.",
      "ìŒì£¼ íšŸìˆ˜ë¥¼ ì£¼ 2íšŒ ì´í•˜ë¡œ ìœ ì§€í•œë‹¤.",
      "ìˆ Â·ì¹´í˜ì¸Â·ì•½ë¬¼ ë“±ì´ ëª¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì•Œê³  ìˆë‹¤.",
      "ì•ˆì „ê³¼ íšŒë³µë ¥ì„ ì ê²€í•˜ê³  ê°œì„ í•˜ë ¤ ë…¸ë ¥í•œë‹¤.",
      "ë¬¸ì œ ìŠµê´€ê³¼ í–‰ë™ì— ëŒ€í•´ ì¸ì‹í•˜ê³  ìˆë‹¤."
    ],
    "color":"#FD79A8"
  }
];

// ========================
// ìœ í‹¸
// ========================
const esc=(s)=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
const show=(el)=>el&&el.classList.remove('hidden');
const hide=(el)=>el&&el.classList.add('hidden');
function adjustColor(hex,percent){const num=parseInt(hex.replace('#',''),16);const amt=Math.round(2.55*percent);const R=(num>>16)+amt,G=(num>>8&255)+amt,B=(num&255)+amt;const clamp=v=>v<0?0:v>255?255:v;return'#'+((1<<24)+(clamp(R)<<16)+(clamp(G)<<8)+(clamp(B))).toString(16).slice(1);}
function updateDebugInfo(db,app,err='ì—†ìŒ'){const a=document.getElementById('dbStatus'),b=document.getElementById('appStatus'),c=document.getElementById('errorStatus'); if(a)a.textContent=db; if(b)b.textContent=app; if(c)c.textContent=err;}

// ========================
// IndexedDB
// ========================
async function initDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=(e)=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('coaches')){
        const s=db.createObjectStore('coaches',{keyPath:'name'}); s.createIndex('name','name',{unique:true});
      }
      if(!db.objectStoreNames.contains('records')){
        const s=db.createObjectStore('records',{keyPath:'id',autoIncrement:true});
        s.createIndex('byCoach','coachName');
        s.createIndex('byClient','clientName');
        s.createIndex('byCoachClientDate',['coachName','clientName','date']);
      }
      if(!db.objectStoreNames.contains('clients')){
        const s=db.createObjectStore('clients',{keyPath:'key'});
        s.createIndex('byCoach','coachName');
        s.createIndex('byCoachClient',['coachName','clientName'],{unique:true});
        s.createIndex('byName','clientName');
      }
      if(!db.objectStoreNames.contains('drafts')){
        const s=db.createObjectStore('drafts',{keyPath:'key'});
        s.createIndex('byCoach','key');
      }
      // SOAP Notes ì¶”ê°€
      if(!db.objectStoreNames.contains('soapNotes')){
        const s=db.createObjectStore('soapNotes',{keyPath:'id',autoIncrement:true});
        s.createIndex('byCoach','coachName');
        s.createIndex('byClient','clientName');
        s.createIndex('byCoachClient',['coachName','clientName']);
        s.createIndex('byDate','date');
      }
    }; req.onsuccess=()=>{_db=req.result;resolve(_db)};
    req.onerror=()=>reject(req.error);
  });
}

async function sha256(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
const randSalt=()=>Math.random().toString(36).slice(2)+crypto.getRandomValues(new Uint32Array(1))[0].toString(36);

// coaches
async function getCoach(name){if(!_db)await initDB();return new Promise((res,rej)=>{const tx=_db.transaction('coaches','readonly');const st=tx.objectStore('coaches');const r=st.get(name);r.onsuccess=()=>res(r.result||null);r.onerror=()=>rej(r.error);});}
async function registerCoach(name,password){if(!_db)await initDB(); if(await getCoach(name)) throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ì¹˜ ì´ë¦„ì…ë‹ˆë‹¤.'); const salt=randSalt(); const pwHash=await sha256(password+salt); return new Promise((res,rej)=>{const tx=_db.transaction('coaches','readwrite');const st=tx.objectStore('coaches');const r=st.put({name,salt,pwHash,registeredDate:new Date().toISOString()});r.onsuccess=()=>res(true);r.onerror=()=>rej(r.error);});}
async function authCoach(name,password){const c=await getCoach(name); if(!c) return null; const ok=(await sha256(password+c.salt))===c.pwHash; return ok?c:null;}

// clients
const clientKey=(coach,client)=>`${coach}|${client}`;
async function upsertClient(coachName, profile){
  if(!_db) await initDB();
  return new Promise((res, rej) => {
    const tx = _db.transaction('clients', 'readwrite');
    const st = tx.objectStore('clients');
    const key = clientKey(coachName, profile.clientName);

    const get = st.get(key);
    get.onsuccess = () => {
      const prev = get.result || {
        key,
        coachName,
        clientName: profile.clientName,
        createdAt: new Date().toISOString()
      };

      const next = {
        ...prev, // ì¤‘ìš”: ìŠ¤í”„ë ˆë“œ ë¬¸ë²• (...prev)
        memberNumber: profile.memberNumber || prev.memberNumber || '',
        gender:       profile.gender       || prev.gender       || '',
        age:          profile.age          || prev.age          || '',
        phone:        profile.phone        || prev.phone        || '',
        heightCm:     profile.heightCm     || prev.heightCm     || '',
        // â¬‡ï¸ ìƒˆ í•„ë“œ ë³‘í•© (ëˆ„ë½ ë°©ì§€)
        weightKg:     profile.weightKg     || prev.weightKg     || '',
        rhr:          profile.rhr          || prev.rhr          || '',
        updatedAt: new Date().toISOString()
      };

      const put = st.put(next);
      put.onsuccess = () => res(next);
      put.onerror  = () => rej(put.error);
    };
    get.onerror = () => rej(get.error);
  });
}
async function fetchClientsByCoach(coachName){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const out=[]; const tx=_db.transaction('clients','readonly'); const idx=tx.objectStore('clients').index('byCoach');
    const req=idx.openCursor(IDBKeyRange.only(coachName));
    req.onsuccess=()=>{const cur=req.result; if(cur){out.push(cur.value); cur.continue();} else res(out);};
    req.onerror=()=>rej(req.error);
  });
}

// records
async function saveRecord(rec){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('records','readwrite');const st=tx.objectStore('records');
    const r = st.put({ ...rec, schema: 2, savedAt: new Date().toISOString() });
    r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  });
}
async function fetchRecords(coachName,clientName){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const out=[]; const tx=_db.transaction('records','readonly'); const idx=tx.objectStore('records').index('byCoachClientDate');
    const range=IDBKeyRange.bound([coachName,clientName,''],[coachName,clientName,'\uFFFF']);
    const req=idx.openCursor(range);
    req.onsuccess=()=>{const cur=req.result; if(cur){out.push(cur.value); cur.continue();} else{out.sort((a,b)=>a.date.localeCompare(b.date)); res(out);} };
    req.onerror=()=>rej(req.error);
  });
}
async function fetchCoachAllRecords(coachName){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const out=[]; const tx=_db.transaction('records','readonly'); const idx=tx.objectStore('records').index('byCoach');
    const req=idx.openCursor(IDBKeyRange.only(coachName));
    req.onsuccess=()=>{const cur=req.result; if(cur){out.push(cur.value); cur.continue();} else res(out);};
    req.onerror=()=>rej(req.error);
  });
}

// SOAP Notes - ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ë“¤
async function saveSoapNoteDB(note){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('soapNotes','readwrite');
    const st=tx.objectStore('soapNotes');
    const r=st.put({...note,savedAt:new Date().toISOString()});
    r.onsuccess=()=>res(r.result); 
    r.onerror=()=>rej(r.error);
  });
}

async function fetchSoapNotes(coachName,clientName){
  if(!_db)await initDB();
  return new Promise((res,rej)=>{
    const out=[]; 
    const tx=_db.transaction('soapNotes','readonly'); 
    const idx=tx.objectStore('soapNotes').index('byCoachClient');
    const range=IDBKeyRange.only([coachName,clientName]);
    const req=idx.openCursor(range);
    req.onsuccess=()=>{
      const cur=req.result; 
      if(cur){
        out.push(cur.value); 
        cur.continue();
      } else {
        out.sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()); // ìµœì‹ ìˆœ
        res(out);
      }
    };
    req.onerror=()=>rej(req.error);
  });
}

// ========================
// ë Œë”/UI
// ========================
function navTo(view){
  document.body.dataset.view = view;
  currentView=view;
  ['loginSection','infoSection','assessmentSection','resultsSection','progressSection','notesSection'].forEach(id=>hide(document.getElementById(id)));
  const topNav=document.getElementById('topNav');

  if(view==='login'){ 
    show(document.getElementById('loginSection')); 
    hide(topNav); 
    hideFloatingProgress(); 
    return; 
  }
  if(!currentCoach){ navTo('login'); return; }

  show(topNav);
  if(view==='measurement'){ 
    loadDraft().then(d=>{ if(d && confirm('ì‘ì„± ì¤‘ì´ë˜ ì„ì‹œ ì €ì¥ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë³µêµ¬í• ê¹Œìš”?')){ fillForm(d); } });
    show(document.getElementById('infoSection'));
    show(document.getElementById('assessmentSection'));
    show(document.getElementById('resultsSection'));
    updateResults(); 
    showFloatingProgress();
  }else if(view==='progress'){ 
    show(document.getElementById('progressSection'));
    hideFloatingProgress();
    populateProgressClientList();
    renderSparklines();
    const name=document.getElementById('clientName')?.value?.trim() || document.getElementById('progressClientSearch')?.value?.trim() || '';
    if(name) {
      document.getElementById('progressClientSearch').value = name;
      renderProgress(name);
    } else {
      renderProgress('');
    }
  }else if(view==='notes'){
    show(document.getElementById('notesSection'));
    hideFloatingProgress();
    populateNotesClientList();
    const name=document.getElementById('clientName')?.value?.trim() || document.getElementById('notesClientSearch')?.value?.trim() || '';
    if(name) {
      document.getElementById('notesClientSearch').value = name;
      renderNotes(name);
    } else {
      renderNotes('');
    }
    document.getElementById('notesCoachLabel').textContent = currentCoach?.name || '-';
  }
}

// SOAP Notes UI í•¨ìˆ˜ë“¤
function switchSoapTab(section) {
  // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
  document.querySelectorAll('.soap-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`.soap-tab[onclick="switchSoapTab('${section}')"]`).classList.add('active');
  
  // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
  document.querySelectorAll('.soap-section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(`${section}-section`).classList.add('active');
}

function addTemplate(section, text) {
  const textarea = document.getElementById(`${section}Text`);
  if (textarea.value.trim()) {
    textarea.value += '\n\n' + text;
  } else {
    textarea.value = text;
  }
  textarea.focus();
}

function loadObjectiveData() {
  const clientName = document.getElementById('clientName')?.value || document.getElementById('notesClientSearch')?.value || '';
  if (!clientName) {
    alert('ë¨¼ì € íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // í˜„ì¬ ì¸¡ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const height = document.getElementById('heightCm')?.value;
  const weight = document.getElementById('weightKg')?.value;
  const rhr = document.getElementById('rhr')?.value;
  const age = document.getElementById('age')?.value;
  
  let objectiveData = `ì¸¡ì •ì¼: ${new Date().toLocaleDateString('ko-KR')}\n`;
  objectiveData += `íšŒì›: ${clientName}\n`;
  
  if (height && weight) {
    const bmi = (parseFloat(weight) / Math.pow(parseFloat(height)/100, 2)).toFixed(1);
    objectiveData += `ì‹ ì¥: ${height}cm, ì²´ì¤‘: ${weight}kg, BMI: ${bmi}\n`;
  }
  
  if (rhr) {
    objectiveData += `ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜: ${rhr}bpm\n`;
  }
  
  if (age && rhr) {
    const mhr = 220 - parseInt(age);
    const hrr = mhr - parseInt(rhr);
    objectiveData += `ìµœëŒ€ì‹¬ë°•ìˆ˜: ${mhr}bpm, ì‹¬ë°•ìˆ˜ ì˜ˆë¹„ëŸ‰: ${hrr}bpm\n`;
  }
  
  // ì›°ë‹ˆìŠ¤ ì ìˆ˜ê°€ ìˆë‹¤ë©´ ì¶”ê°€
  const {total} = computeScores();
  if (total > 0) {
    objectiveData += `ì›°ë‹ˆìŠ¤ ì ìˆ˜: ${total}/300\n`;
  }
  
  objectiveData += '\n[ì¶”ê°€ ì¸¡ì • ë°ì´í„°]\nì²´ì§€ë°©ë¥ : %\nê·¼ìœ¡ëŸ‰: kg\ní˜ˆì••: / mmHg\nê¸°íƒ€: ';
  
  document.getElementById('objectiveText').value = objectiveData;
}

async function saveSoapNoteUI() {
  if (!currentCoach) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  const clientName = document.getElementById('notesClientSearch').value.trim();
  if (!clientName) {
    alert('íšŒì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const subjective = document.getElementById('subjectiveText').value.trim();
  const objective = document.getElementById('objectiveText').value.trim();
  const assessment = document.getElementById('assessmentText').value.trim();
  const plan = document.getElementById('planText').value.trim();
  
  if (!subjective && !objective && !assessment && !plan) {
    alert('ìµœì†Œ í•œ ê°œ í•­ëª©ì€ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const note = {
    date: new Date().toISOString(),
    coachName: currentCoach.name,
    clientName,
    subjective,
    objective,
    assessment,
    plan
  };
  
  try {
    await saveSoapNoteDB(note);
    alert('ì§„í–‰ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    clearSoapForm();
    renderNotes(clientName);
  } catch (e) {
    console.error(e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e?.message || e));
  }
}

function clearSoapForm() {
  document.getElementById('subjectiveText').value = '';
  document.getElementById('objectiveText').value = '';
  document.getElementById('assessmentText').value = '';
  document.getElementById('planText').value = '';
  switchSoapTab('subjective');
}

async function populateNotesClientList() {
  const list = await fetchClientsByCoach(currentCoach?.name || '');
  const dl = document.getElementById('notesClientList');
  if (!dl) return;
  dl.innerHTML = list
    .sort((a,b)=>a.clientName.localeCompare(b.clientName,'ko'))
    .map(c=>`<option value="${c.clientName}"></option>`).join('');
}

async function renderNotes(clientName) {
  const clientLabel = document.getElementById('notesClientLabel');
  const notesList = document.getElementById('soapNotesList');
  
  if (!currentCoach) return;
  
  if (!clientName) {
    clientLabel.textContent = 'íšŒì› ì„ íƒ í›„ í™•ì¸';
    if (notesList) notesList.innerHTML = '<p class="muted">íšŒì›ì„ ì„ íƒí•˜ë©´ ì§„í–‰ë…¸íŠ¸ íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  clientLabel.textContent = clientName;
  
  try {
    const notes = await fetchSoapNotes(currentCoach.name, clientName);
    
    if (!notes.length) {
      notesList.innerHTML = '<p class="muted">ì €ì¥ëœ ì§„í–‰ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    
    const notesHtml = notes.map(note => `
      <div class="note-card">
        <div class="note-header">
          <div class="note-date">${new Date(note.date).toLocaleString('ko-KR')}</div>
          <div class="note-actions">
            <button class="btn" style="padding:4px 8px;font-size:0.8rem" onclick="editSoapNote(${note.id})">ìˆ˜ì •</button>
            <button class="btn btn-warning" style="padding:4px 8px;font-size:0.8rem" onclick="deleteSoapNote(${note.id})">ì‚­ì œ</button>
          </div>
        </div>
        <div class="soap-summary">
          ${note.subjective ? `<div class="soap-summary-item"><div class="soap-summary-title">S - ì£¼ê´€ì </div><div class="note-content">${esc(note.subjective.slice(0, 100))}${note.subjective.length > 100 ? '...' : ''}</div></div>` : ''}
          ${note.objective ? `<div class="soap-summary-item"><div class="soap-summary-title">O - ê°ê´€ì </div><div class="note-content">${esc(note.objective.slice(0, 100))}${note.objective.length > 100 ? '...' : ''}</div></div>` : ''}
          ${note.assessment ? `<div class="soap-summary-item"><div class="soap-summary-title">A - í‰ê°€</div><div class="note-content">${esc(note.assessment.slice(0, 100))}${note.assessment.length > 100 ? '...' : ''}</div></div>` : ''}
          ${note.plan ? `<div class="soap-summary-item"><div class="soap-summary-title">P - ê³„íš</div><div class="note-content">${esc(note.plan.slice(0, 100))}${note.plan.length > 100 ? '...' : ''}</div></div>` : ''}
        </div>
      </div>
    `).join('');
    
    notesList.innerHTML = notesHtml;
  } catch (e) {
    console.error(e);
    notesList.innerHTML = '<p class="muted">ë…¸íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
  }
}

async function deleteSoapNote(noteId) {
  if (!confirm('ì •ë§ ì´ ì§„í–‰ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    if (!_db) await initDB();
    return new Promise((res, rej) => {
      const tx = _db.transaction('soapNotes', 'readwrite');
      const st = tx.objectStore('soapNotes');
      const r = st.delete(noteId);
      r.onsuccess = () => {
        alert('ì§„í–‰ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        const clientName = document.getElementById('notesClientSearch').value;
        renderNotes(clientName);
        res(true);
      };
      r.onerror = () => rej(r.error);
    });
  } catch (e) {
    console.error(e);
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function editSoapNote(noteId) {
  try {
    if (!_db) await initDB();
    const note = await new Promise((res, rej) => {
      const tx = _db.transaction('soapNotes', 'readonly');
      const st = tx.objectStore('soapNotes');
      const r = st.get(noteId);
      r.onsuccess = () => res(r.result);
      r.onerror = () => rej(r.error);
    });
    
    if (!note) {
      alert('ë…¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // SOAP í¼ì— ê¸°ì¡´ ë‚´ìš© ë¡œë“œ
    document.getElementById('subjectiveText').value = note.subjective || '';
    document.getElementById('objectiveText').value = note.objective || '';
    document.getElementById('assessmentText').value = note.assessment || '';
    document.getElementById('planText').value = note.plan || '';
    
    // ì €ì¥ ë²„íŠ¼ì„ ìˆ˜ì • ëª¨ë“œë¡œ ë³€ê²½
    const saveBtn = document.querySelector('#soapWritePanel .btn-success');
    saveBtn.textContent = 'ë…¸íŠ¸ ìˆ˜ì •';
    saveBtn.onclick = () => updateSoapNote(noteId);
    
    switchSoapTab('subjective');
    document.getElementById('soapWritePanel').scrollIntoView({ behavior: 'smooth' });
    
  } catch (e) {
    console.error(e);
    alert('ë…¸íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function updateSoapNote(noteId) {
  const subjective = document.getElementById('subjectiveText').value.trim();
  const objective = document.getElementById('objectiveText').value.trim();
  const assessment = document.getElementById('assessmentText').value.trim();
  const plan = document.getElementById('planText').value.trim();
  
  if (!subjective && !objective && !assessment && !plan) {
    alert('ìµœì†Œ í•œ ê°œ í•­ëª©ì€ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    if (!_db) await initDB();
    
    // ê¸°ì¡´ ë…¸íŠ¸ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
    const existingNote = await new Promise((res, rej) => {
      const tx = _db.transaction('soapNotes', 'readonly');
      const st = tx.objectStore('soapNotes');
      const r = st.get(noteId);
      r.onsuccess = () => res(r.result);
      r.onerror = () => rej(r.error);
    });
    
    const updatedNote = {
      ...existingNote,
      subjective,
      objective,
      assessment,
      plan,
      updatedAt: new Date().toISOString()
    };
    
    await new Promise((res, rej) => {
      const tx = _db.transaction('soapNotes', 'readwrite');
      const st = tx.objectStore('soapNotes');
      const r = st.put(updatedNote);
      r.onsuccess = () => res(true);
      r.onerror = () => rej(r.error);
    });
    
    alert('ì§„í–‰ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ì €ì¥ ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë³µì›
    const saveBtn = document.querySelector('#soapWritePanel .btn-success');
    saveBtn.textContent = 'ì§„í–‰ë…¸íŠ¸ ì €ì¥';
    saveBtn.onclick = saveSoapNoteUI;
    
    clearSoapForm();
    const clientName = document.getElementById('notesClientSearch').value;
    renderNotes(clientName);
    
  } catch (e) {
    console.error(e);
    alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

function renderCategories(){
  const container=document.getElementById('categoriesContainer'); if(!container) return;
  container.innerHTML='';
  categories.forEach((cat,ci)=>{
    const wrap=document.createElement('div'); wrap.className='category';
    wrap.innerHTML=`
      <div class="category-header" style="background:linear-gradient(135deg,${cat.color} 0%,${adjustColor(cat.color,-20)} 100%)">${esc(cat.name)}</div>
      <div class="questions">
        ${cat.questions.map((q,qi)=>`
          <fieldset class="question">
            <legend class="question-text">${esc(q)}</legend>
            <div class="rating-scale" data-ci="${ci}" data-qi="${qi}">
              ${[1,2,3,4,5].map(v=>`
                <label class="rating-option">
                  <input type="radio" name="q${ci}_${qi}" value="${v}" onchange="handleRatingChange(this)"/>
                  <span>${v}</span>
                </label>
              `).join('')}
            </div>
            <div class="rating-guide"><span>1 ì „í˜€ ì•„ë‹˜</span><span>2 ê±°ì˜ ì•ˆ í•¨</span><span>3 ê°€ë”</span><span>4 ìì£¼</span><span>5 ë§¤ìš° ê·¸ëŸ¼</span></div>
          </fieldset>
        `).join('')}
      </div>
      <div class="category-score" id="score_${ci}">ì¹´í…Œê³ ë¦¬ ì ìˆ˜: 0/${MAX_PER_CAT}</div>
    `;
    container.appendChild(wrap);
  });
}

function handleRatingChange(input){
  const parent=input.closest('.rating-scale'); if(!parent) return;
  parent.querySelectorAll('.rating-option').forEach(o=>o.classList.remove('selected'));
  input.closest('.rating-option').classList.add('selected');
  const ci=+parent.dataset.ci;
  updateCategoryScore(ci); updateProgress(); updateResults();
}

function updateCategoryScore(ci){
  let s=0; for(let qi=0;qi<QUESTIONS_PER_CAT;qi++){const el=document.querySelector(`input[name="q${ci}_${qi}"]:checked`); s+=parseInt(el?.value||'0',10);}
  const el=document.getElementById(`score_${ci}`); if(el) el.textContent=`ì¹´í…Œê³ ë¦¬ ì ìˆ˜: ${s}/${MAX_PER_CAT}`;
}

function updateProgress(){
  const answered=document.querySelectorAll('.rating-scale input:checked').length;
  const totalQ=categories.length*QUESTIONS_PER_CAT;
  const pct=Math.round((answered/totalQ)*100);
  const fill=document.getElementById('progressFill'); const text=document.getElementById('progressText');
  if(fill) fill.style.width=pct+'%'; if(text) text.textContent=`ì‘ë‹µë¥  ${pct}%`; updateFloatingProgress(pct);
}

function computeScores(){
  const scores=categories.map((_,ci)=>{let s=0; for(let qi=0;qi<QUESTIONS_PER_CAT;qi++){const el=document.querySelector(`input[name="q${ci}_${qi}"]:checked`); s+=Math.min(5,Math.max(0,parseInt(el?.value||'0',10)));} return s;});
  const total=scores.reduce((a,b)=>a+b,0); return {scores,total};
}

function updateResults(){ 
  const {scores,total}=computeScores(); 
  refreshBaselineOptions().catch(()=>{});
  const totalEl=document.getElementById('finalTotalScore'); 
  if(totalEl) totalEl.textContent=`${total}/300`;
  renderRadarChart(scores); 
  renderScoreCards(scores); 
  renderClientDetails();
}

function renderRadarChart(scores){
  const cvs=document.getElementById('radarChart'); if(!cvs||typeof Chart==='undefined') return;
  if(radarChart) radarChart.destroy();
  radarChart=new Chart(cvs.getContext('2d'),{
    type:'radar',
    data:{labels:categories.map(c=>c.shortLabel||c.name.split(' ')[0]),datasets:[{label:'ì›°ë‹ˆìŠ¤ ì ìˆ˜',data:scores,backgroundColor:'rgba(79,172,254,.18)',borderColor:'rgba(79,172,254,1)',borderWidth:2,pointRadius:4,pointBackgroundColor:'rgba(79,172,254,1)',pointBorderColor:'#fff',pointBorderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{r:{beginAtZero:true,max:MAX_PER_CAT,ticks:{stepSize:5,font:{size:10}},pointLabels:{font:{size:11}}}},plugins:{legend:{display:false}}}
  });
}

let baselineScores = null;
let baselineTotal = null;

async function refreshBaselineOptions(){
  const sel = document.getElementById('baselineSelect'); if(!sel) return;
  const name = document.getElementById('clientName')?.value.trim();
  if(!currentCoach || !name){ sel.innerHTML = '<option value="">ê¸°ì¤€ ì—†ìŒ</option>'; return; }
  const rows = await fetchRecords(currentCoach.name, name);
  const opts = ['<option value="">ê¸°ì¤€ ì—†ìŒ</option>'].concat(rows.map(r=>`<option value="${r.date}">${new Date(r.date).toLocaleDateString('ko-KR')}</option>`));
  sel.innerHTML = opts.join('');
}

async function applyBaseline(iso){
  if(!iso){ baselineScores=null; baselineTotal=null; renderScoreCards(computeScores().scores); return; }
  const name = document.getElementById('clientName')?.value.trim();
  const rows = await fetchRecords(currentCoach.name, name);
  const found = rows.find(r=>r.date===iso); 
  baselineScores = found?.scores||null; 
  baselineTotal = found?.totalScore||null;
  renderScoreCards(computeScores().scores);
}

function renderScoreCards(scores){
  const wrap=document.getElementById('scoresList'); if(!wrap) return; wrap.innerHTML='';
  categories.forEach((cat,i)=>{
    const pct=Math.round((scores[i]/MAX_PER_CAT)*100); 
    const card=document.createElement('div'); card.className='score-card'; 
    const delta=(baselineScores? (scores[i] - (baselineScores[i]||0)) : null); 
    const deltaTag = (delta===null? '' : ` <small class="muted">(${delta>=0?'+':''}${delta})</small>`); 
    card.innerHTML=`
      <div class="score-header"><div class="score-title">${esc(cat.name)}</div><div class="score-number">${scores[i]}${deltaTag}</div></div>
      <div class="score-bar"><div class="score-fill" style="width:${pct}%;background:${cat.color}"></div></div>`;
      wrap.appendChild(card);
  });
}

function renderClientDetails(){
  const box=document.getElementById('clientDetails'); if(!box) return;
  const date=document.getElementById('measurementDate')?.value?new Date(document.getElementById('measurementDate').value):new Date();
  const displayDate=date.toLocaleDateString('ko-KR');
  const clientName=document.getElementById('clientName')?.value||'N/A';
  const gender=document.getElementById('gender')?.value||'N/A';
  const age=document.getElementById('age')?.value;
  const rhr=document.getElementById('rhr')?.value;
  const height=document.getElementById('heightCm')?.value;
  const weight=document.getElementById('weightKg')?.value;
  let bmiText='N/A'; if(height&&weight){const m=parseFloat(height)/100;const kg=parseFloat(weight);const bmi=(kg/(m*m)).toFixed(1);bmiText=`${bmi} kg/mÂ²`;}
  box.innerHTML=`
    <div class="detail"><strong>ì¸¡ì •ì¼</strong><span>${esc(displayDate)}</span></div>
    <div class="detail"><strong>ê³ ê°</strong><span>${esc(clientName)}</span></div>
    <div class="detail"><strong>ì„±ë³„</strong><span>${esc(gender)}</span></div>
    <div class="detail"><strong>ë‚˜ì´</strong><span>${age?esc(age+'ì„¸'):'N/A'}</span></div>
    <div class="detail"><strong>ì‹ ì¥/ì²´ì¤‘</strong><span>${height||'N/A'} cm / ${weight||'N/A'} kg</span></div>
    <div class="detail"><strong>BMI</strong><span>${bmiText}</span></div>
    <div class="detail"><strong>ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜</strong><span>${rhr?rhr+' bpm':'N/A'}</span></div>
    <div class="detail"><strong>ë©”ëª¨</strong><span>${esc((document.getElementById('goalMemo')?.value)||(document.getElementById('goalNote')?.value)||'N/A')}</span></div>
    <div class="detail"><strong>ì½”ì¹˜</strong><span>${esc(currentCoach?.name||'N/A')}</span></div>`;
}

async function handleClientTyping(val){
  // datalist ì œì–´
  const dl = document.getElementById('clientSuggestions');
  if(!dl) return;

  // ì½”ì¹˜ë³„ í´ë¼ì´ì–¸íŠ¸ ëª©ë¡
  const list = await fetchClientsByCoach(currentCoach?.name || '');
  const q = (val || '').trim().toLowerCase();

  // ìë™ì™„ì„± í›„ë³´ êµ¬ì„±
  const filtered = list
    .filter(c => !q || (c.clientName || '').toLowerCase().includes(q))
    .slice(0, 20);

  dl.innerHTML = filtered.map(c => `<option value="${esc(c.clientName)}"></option>`).join('');

  // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì´ë¦„ì´ë©´ ìƒì„¸ê°’ ì±„ì›€
  const pick = list.find(c => (c.clientName || '') === (val || '').trim());
  if (pick){
    const set = (id, v)=>{
      const el = document.getElementById(id);
      if(!el) return;
      // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥ ì¤‘ì¸ í•„ë“œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      if (el === document.activeElement) return;
      el.value = v ?? '';
    };

    set('memberNumber', pick.memberNumber);
    set('gender', pick.gender);
    set('age', pick.age);
    set('phone', pick.phone);
    set('heightCm', pick.heightCm);
    // â¬‡ï¸ ì¶”ê°€: ì²´ì¤‘/ì•ˆì •ì‹œì‹¬ë°•ë„ ìë™ ì±„ì›€
    set('weightKg', pick.weightKg);
    set('rhr', pick.rhr);

    // ê²°ê³¼( BMI, Zone ë“± ) ì¬ê³„ì‚°/í‘œì‹œ
    if (typeof updateResults === 'function') updateResults();
  }
}

function normalizeName(n){return (n||'').toString().trim().toLowerCase().replace(/\s+/g,'').normalize('NFKC');}
function levenshtein(a,b){
  a=a||''; b=b||'';
  const m=Array(b.length+1).fill(0).map((_,i)=>[i]);
  for(let j=0;j<=b.length;j++) m[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      m[i][j]=Math.min(m[i-1][j]+1,m[i][j-1]+1,m[i-1][j-1]+cost);
    }
  }
  return m[a.length][b.length];
}


async function loadLastNoteForClient(name){
  try{
    if(!currentCoach || !name) return;
    const rows = await fetchRecords(currentCoach.name, name);
    if(!rows || !rows.length) return;
    const last = rows[rows.length - 1];
    const ta = document.getElementById('goalMemo');
    if(ta && !ta.value){ ta.value = last.note || ''; }
  }catch(e){ /* noop */ }
}

// ========================
// ì§„í–‰ìƒí™©(ì¶”ì´)
// ========================
let progressRangeDays = null;
let currentProgressClient = '';
function setProgressRange(n){ progressRangeDays = n; if(currentProgressClient) renderProgress(currentProgressClient); }
function applyRange(rows){
  if(!progressRangeDays) return rows;
  const cut = Date.now() - progressRangeDays*86400000;
  return rows.filter(r=>new Date(r.date).getTime()>=cut);
}
function movingAvg(arr, k=3){
  if(arr.length===0) return arr;
  const out=[];
  for(let i=0;i<arr.length;i++){
    let s=0,c=0;
    for(let j=Math.max(0,i-k+1); j<=i; j++){ s+=arr[j]; c++; }
    out.push(Math.round(s/c));
  }
  return out;
}

function destroyProgressCharts(){ 
  if(totalTrendChart){totalTrendChart.destroy(); totalTrendChart=null;} 
  if(latestCategoryChart){latestCategoryChart.destroy(); latestCategoryChart=null;} 
  if(miniTrendChart){miniTrendChart.destroy(); miniTrendChart=null;} 
}

async function renderProgress(name){
  const lbl=document.getElementById('progressClientLabel');
  const tbody=document.getElementById('historyTbody');
  const statsBox=document.getElementById('progressStats');
  if(!currentCoach){return;}
  if(!name){ 
    lbl.textContent='íšŒì› ì„ íƒ í›„ í™•ì¸'; 
    if(tbody) tbody.innerHTML=''; 
    if(statsBox) statsBox.innerHTML=''; 
    destroyProgressCharts(); 
    return; 
  }
  lbl.textContent=name; 
  currentProgressClient=name; 
  let rows=await fetchRecords(currentCoach.name,name); 
  rows = applyRange(rows);
  
  tbody.innerHTML=rows.length?rows.map(r=>`<tr><td>${new Date(r.date).toLocaleDateString('ko-KR')}</td><td>${r.totalScore}</td><td>${r.weightKg||'-'}</td><td>${r.rhr||'-'}</td><td>${(r.note||'').slice(0,30)}</td></tr>`).join(''):'<tr><td colspan="5">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  
  if(rows.length){
    const first=rows[0], last=rows[rows.length-1];
    const delta=last.totalScore-first.totalScore;
    const count=rows.length;
    const avg=(rows.reduce((a,b)=>a+b.totalScore,0)/count).toFixed(1);
    statsBox.innerHTML=`
      <div class="detail"><strong>ì¸¡ì • íšŸìˆ˜</strong><span>${count}íšŒ</span></div>
      <div class="detail"><strong>ìµœì´ˆ ì ìˆ˜</strong><span>${first.totalScore}</span></div>
      <div class="detail"><strong>ìµœì‹  ì ìˆ˜</strong><span>${last.totalScore}</span></div>
      <div class="detail"><strong>ì ìˆ˜ ë³€í™”ëŸ‰</strong><span>${delta>=0?`+${delta}`:delta}</span></div>
      <div class="detail"><strong>í‰ê·  ì ìˆ˜</strong><span>${avg}</span></div>
      <div class="detail"><strong>ë§ˆì§€ë§‰ ì¸¡ì •ì¼</strong><span>${new Date(last.date).toLocaleDateString('ko-KR')}</span></div>`;
  }else{ 
    statsBox.innerHTML='<div class="detail"><strong>ì•Œë¦¼</strong><span>ê¸°ë¡ ì—†ìŒ</span></div>'; 
  }
  renderTotalTrend(rows); 
  renderLatestCategory(rows); 
  renderMiniTrend(rows);
}

// CSV ê´€ë ¨ í•¨ìˆ˜ë“¤
let parsedImport = null;
function triggerCSVImport(){ const inp=document.getElementById('csvInput'); if(inp) inp.value=''; inp?.click(); }
function parseCSV(text){
  const lines = text.replace(/\r\n/g,'\n').split(/\n+/).filter(Boolean);
  const rows = [];
  let headers = null;
  for(let i=0;i<lines.length;i++){
    const cols = []; let cur=''; let inQ=false;
    const line = lines[i];
    for(let j=0;j<line.length;j++){
      const ch = line[j];
      if(ch=='"'){ if(inQ && line[j+1]=='"'){ cur+='"'; j++; } else { inQ=!inQ; } }
      else if(ch==',' && !inQ){ cols.push(cur); cur=''; }
      else { cur+=ch; }
    }
    cols.push(cur);
    if(i===0){ headers = cols; } else { rows.push(cols); }
  }
  return {headers, rows};
}

function handleCSVFile(file){
  if(!file) return;
  const fr = new FileReader();
  fr.onload = () => {
    const {headers, rows} = parseCSV(fr.result);
    parsedImport = {headers, rows};
    const prev = document.getElementById('importPreview');
    const panel = document.getElementById('importPreviewPanel');
    if(prev) {
      const sample = rows.slice(0,5).map(r=>r.join(' | ')).join('<br/>');
      prev.innerHTML = `<div class="detail"><strong>í–‰ ìˆ˜</strong><span>${rows.length}</span></div>
                        <div class="detail"><strong>í—¤ë”</strong><span>${headers.join(', ')}</span></div>
                        <div class="detail"><strong>ìƒ˜í”Œ(5)</strong><span style="white-space:pre-line">${sample}</span></div>`;
    }
    panel?.classList.remove('hidden');
  };
  fr.readAsText(file, 'utf-8');
}

function cancelImportCSV(){ 
  parsedImport=null; 
  document.getElementById('importPreviewPanel')?.classList.add('hidden'); 
}

async function confirmImportCSV(){
  if(!parsedImport){ alert('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const h = parsedImport.headers;
  const idx = { 
    date:h.indexOf('ë‚ ì§œ'), coach:h.indexOf('ì½”ì¹˜'), client:h.indexOf('íšŒì›'), gender:h.indexOf('ì„±ë³„'),
    age:h.indexOf('ë‚˜ì´'), memberNumber:h.indexOf('íšŒì›ë²ˆí˜¸'), phone:h.indexOf('ì „í™”'), height:h.indexOf('í‚¤(cm)'),
    weight:h.indexOf('ì²´ì¤‘(kg)'), rhr:h.indexOf('RHR(bpm)'), total:(h.indexOf('ì ìˆ˜')!==-1?h.indexOf('ì ìˆ˜'):h.indexOf('ì´ì ')) 
  };
  const scoreIdx = h.map((x,i)=> ({x,i})).filter(o=>/^ì¹´í…Œê³ ë¦¬\d+/.test(o.x)).map(o=>o.i);
  let imported=0, skipped=0;
  
  for(const row of parsedImport.rows){
    const coachName = row[idx.coach]||currentCoach?.name||'';
    if(!currentCoach || coachName!==currentCoach.name){ skipped++; continue; }
    const rec = {
      date: row[idx.date]? new Date(row[idx.date]).toISOString() : new Date().toISOString(),
      coachName,
      clientName: row[idx.client]||'',
      gender: row[idx.gender]||'',
      age: row[idx.age]||'',
      memberNumber: row[idx.memberNumber]||'',
      phone: row[idx.phone]||'',
      heightCm: row[idx.height]||'',
      weightKg: row[idx.weight]||'',
      rhr: row[idx.rhr]||'',
      scores: scoreIdx.map(i=> parseInt(row[i]||'0',10) ),
      totalScore: parseInt(row[idx.total]||'0',10),
      categoryScores: []
    };
    try{
      await upsertClient(coachName, {clientName: rec.clientName, memberNumber:rec.memberNumber, gender:rec.gender, age:rec.age, phone:rec.phone, heightCm:rec.heightCm});
      await saveRecord(rec);
      imported++;
    }catch(e){ skipped++; }
  }
  alert(`ë³µì› ì™„ë£Œ: ${imported}ê±´, ê±´ë„ˆëœ€: ${skipped}ê±´`);
  cancelImportCSV();
  if(currentView==='progress' && currentProgressClient){ renderProgress(currentProgressClient); renderSparklines(); }
}

function renderTotalTrend(rows){
  const cvs=document.getElementById('totalTrendChart'); if(!cvs||typeof Chart==='undefined') return;
  if(totalTrendChart) totalTrendChart.destroy();
  const labels=rows.map(r=>new Date(r.date).toLocaleDateString('ko-KR'));
  let data=rows.map(r=>r.totalScore);
  if(document.getElementById('ma3')?.checked){ data = movingAvg(data,3);}
  totalTrendChart=new Chart(cvs.getContext('2d'),{type:'line',data:{labels,datasets:[{label:'ì ìˆ˜',data,borderWidth:2,fill:false,tension:.2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:300}}}});
}

async function renderSparklines(){
  const wrap = document.getElementById('sparklineWrap'); if(!wrap) return;
  wrap.innerHTML = '';
  const clients = await fetchClientsByCoach(currentCoach?.name||'');
  for(const c of clients){
    const recs = (await fetchRecords(currentCoach.name, c.clientName)).slice(-8);
    const labels = recs.map(r=>new Date(r.date).toLocaleDateString('ko-KR'));
    const data = recs.map(r=>r.totalScore);
    const card = document.createElement('div');
    card.className='score-card';
    const cid = 'spark_'+Math.random().toString(36).slice(2);
    card.innerHTML = `<div class="score-header"><div class="score-title">${c.clientName}</div><div class="score-number">${data[data.length-1]||'-'}</div></div><div style="height:80px"><canvas id="${cid}"></canvas></div>`;
    wrap.appendChild(card);
    const ctx = document.getElementById(cid).getContext('2d');
    new Chart(ctx,{type:'line', data:{labels, datasets:[{data, borderWidth:2, fill:false, tension:.2}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}}});
  }
}

function renderLatestCategory(rows){
  const cvs=document.getElementById('latestCategoryChart'); if(!cvs||typeof Chart==='undefined') return;
  if(latestCategoryChart) latestCategoryChart.destroy();
  const last=rows[rows.length-1]; 
  const labels=categories.map(c=>c.shortLabel); 
  const data=last?last.scores:new Array(categories.length).fill(0);
  latestCategoryChart=new Chart(cvs.getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'ìµœì‹  ì ìˆ˜',data}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:MAX_PER_CAT}}}});
}

async function renderMiniTrend(rows){
  const cvs=document.getElementById('miniTrendChart'); if(!cvs||typeof Chart==='undefined') return;
  if(miniTrendChart) miniTrendChart.destroy();
  if(!rows){
    const name=document.getElementById('clientName')?.value.trim();
    rows = (name && currentCoach)? await fetchRecords(currentCoach.name,name) : [];
  }
  const lastN=rows.slice(-8);
  const labels=lastN.map(r=>new Date(r.date).toLocaleDateString('ko-KR'));
  const data=lastN.map(r=>r.totalScore);
  miniTrendChart=new Chart(cvs.getContext('2d'),{type:'line',data:{labels,datasets:[{label:'ì ìˆ˜(ìµœê·¼)',data,borderWidth:2,fill:false,tension:.2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:300}}}});
}

function resultNav(section){
  const targetIds = {
    summary: 'resultInfoPanel',
    radar: 'resultRadarPanel',
    categories: 'resultCategoryPanel',
    trend: 'resultsTrendPanel'
  };
  const id = targetIds[section];
  const el = document.getElementById(id);
  if(el){ el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
}

async function populateProgressClientList(){
  const list = await fetchClientsByCoach(currentCoach?.name || '');
  const dl = document.getElementById('progressClientList');
  if (!dl) return;
  dl.innerHTML = list
    .sort((a,b)=>a.clientName.localeCompare(b.clientName,'ko'))
    .map(c=>`<option value="${c.clientName}"></option>`).join('');
}

function calcBMI(heightCm, weightKg){
  const h = parseFloat(heightCm), w = parseFloat(weightKg);
  if(!h || !w) return null;
  const m = h / 100;
  return (w / (m*m));
}
function bmiCategory(b){
  if(b < 18.5) return 'ì €ì²´ì¤‘';
  if(b < 25) return 'ì •ìƒ';
  if(b < 30) return 'ê³¼ì²´ì¤‘';
  return 'ë¹„ë§Œ';
}
function renderBMI(){
  const h = document.getElementById('heightCm')?.value;
  const w = document.getElementById('weightKg')?.value;
  const v = calcBMI(h,w);
  const valEl = document.getElementById('bmiValue');
  const catEl = document.getElementById('bmiCategory');
  const marker = document.getElementById('bmiMarker');
  if(!valEl || !catEl || !marker){ return; }
  if(!v){ valEl.textContent='-'; catEl.textContent='-'; marker.style.left='0'; return; }
  const b = Math.round(v*10)/10;
  valEl.textContent = b.toFixed(1);
  catEl.textContent = bmiCategory(b);
  const px = Math.max(0, Math.min(40, b));
  const leftPct = (px / 40) * 100;
  marker.style.left = `calc(${leftPct}% - 1px)`;
}
function renderZones(){
  const age = parseInt(document.getElementById('age')?.value||'',10);
  const rhr = parseInt(document.getElementById('rhr')?.value||'',10);
  const lbl = document.getElementById('mhrRhrLabel');
  const z1 = document.getElementById('z1Range');
  const z2 = document.getElementById('z2Range');
  const z3 = document.getElementById('z3Range');
  if(!lbl || !z1 || !z2 || !z3) return;
  if(!age || !rhr){
    lbl.textContent='-';
    z1.textContent = z2.textContent = z3.textContent = '-';
    return;
  }
  const mhr = 220 - age;
  const hrr = mhr - rhr;
  const zone = (lo, hi) => {
    const a = Math.round(rhr + hrr * lo);
    const b = Math.round(rhr + hrr * hi);
    return `${a}â€”${b} bpm`;
  };
  lbl.textContent = `MHR ${mhr} / RHR ${rhr}`;
  z1.textContent = zone(0.50, 0.60);
  z2.textContent = zone(0.60, 0.70);
  z3.textContent = zone(0.70, 0.80);
}
// ë°”ì¸ë”©
['heightCm','weightKg','age','rhr'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){ el.addEventListener('input', ()=>{ renderBMI(); renderZones(); renderClientDetails(); }); }
});
setTimeout(()=>{ try{ renderBMI(); renderZones(); }catch(e){} }, 0);


// ========================
// CSV Export
// ========================
function csvEscape(v){const s=(v===undefined||v===null)?'':String(v); return '"'+s.replace(/"/g,'""')+'"';}
function downloadCSV(filename,rows){const bom='\uFEFF'; const csv=rows.map(r=>r.join(',')).join('\r\n'); const blob=new Blob([bom+csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);}
function buildHeader(){const cat=categories.map((c,i)=>`ì¹´í…Œê³ ë¦¬${i+1}:${c.shortLabel||c.name}`); return ['ë‚ ì§œ','ì½”ì¹˜','íšŒì›','ì„±ë³„','ë‚˜ì´','íšŒì›ë²ˆí˜¸','ì „í™”','í‚¤(cm)','ì²´ì¤‘(kg)','RHR(bpm)','ì ìˆ˜',...cat];}
function buildCurrentResultRow(){const {scores,total}=computeScores(); const dateStr=(document.getElementById('measurementDate').value?new Date(document.getElementById('measurementDate').value):new Date()).toISOString().split('T')[0]; const row=[dateStr,currentCoach?.name||'',document.getElementById('clientName')?.value||'',document.getElementById('gender')?.value||'',document.getElementById('age')?.value||'',document.getElementById('memberNumber')?.value||'',document.getElementById('phone')?.value||'',document.getElementById('heightCm')?.value||'',document.getElementById('weightKg')?.value||'',document.getElementById('rhr')?.value||'',total,...scores]; return row.map(csvEscape);}
function buildRowsFromRecords(recs){const rows=[]; for(const r of recs){const scores=(r.scores&&r.scores.length===categories.length)?r.scores:categories.map(()=>0); const row=[(r.date?new Date(r.date).toISOString().split('T')[0]:''),r.coachName||'',r.clientName||'',r.gender||'',r.age||'',r.memberNumber||'',r.phone||'',r.heightCm||'',r.weightKg||'',r.rhr||'',r.totalScore??'',...scores]; rows.push(row.map(csvEscape));} return rows;}

async function exportCSVMenu(){ 
  if(!currentCoach){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');return;} 
  const choice=prompt('CSV ë‚´ë³´ë‚´ê¸° ì¢…ë¥˜:\n1=í˜„ì¬ ê²°ê³¼ 1ê±´\n2=ì„ íƒ íšŒì› íˆìŠ¤í† ë¦¬\n3=ì½”ì¹˜ ì „ì²´ ê¸°ë¡'); 
  if(!choice) return; 
  if(choice.trim()==='1'){
    const header=buildHeader().map(csvEscape); 
    const row=buildCurrentResultRow(); 
    downloadCSV(`ì›°ë‹ˆìŠ¤_í˜„ì¬ê²°ê³¼_${new Date().toISOString().split('T')[0]}.csv`,[header,row]);
  } else if(choice.trim()==='2'){
    const name=(document.getElementById('clientName')?.value||'').trim()||document.getElementById('progressClientSearch').value.trim()||document.getElementById('notesClientSearch').value.trim(); 
    if(!name){alert('íšŒì› ì´ë¦„ì„ ë¨¼ì € ì…ë ¥/ì„ íƒí•˜ì„¸ìš”.');return;} 
    const recs=await fetchRecords(currentCoach.name,name); 
    if(!recs.length){alert('í•´ë‹¹ íšŒì›ì˜ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');return;} 
    recs.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); 
    const header=buildHeader().map(csvEscape); 
    const rows=buildRowsFromRecords(recs); 
    downloadCSV(`Wellness_${name}_íˆìŠ¤í† ë¦¬_${new Date().toISOString().split('T')[0]}.csv`,[header,...rows]);
  } else if(choice.trim()==='3'){
    const recs=await fetchCoachAllRecords(currentCoach.name); 
    if(!recs.length){alert('ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');return;} 
    recs.sort((a,b)=>{const d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d; return (a.clientName||'').localeCompare(b.clientName||'');}); 
    const header=buildHeader().map(csvEscape); 
    const rows=buildRowsFromRecords(recs); 
    downloadCSV(`Wellness_${currentCoach.name}_ì „ì²´ê¸°ë¡_${new Date().toISOString().split('T')[0]}.csv`,[header,...rows]);
  } else {
    alert('1, 2, 3 ì¤‘ì—ì„œ ì„ íƒí•˜ì„¸ìš”.');
  }
}

// ========================
// ì•¡ì…˜
// ========================
async function handleLogin(){ 
  await initDB();
  const name=document.getElementById('loginCoachName').value.trim();
  const pw=document.getElementById('loginPassword').value;
  if(!name||!pw){
    alert('ì½”ì¹˜ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const coachData = await getCoach(name);
  if(!coachData){
    alert('ë“±ë¡ëœ ì½”ì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ë¨¼ì € "ì‹ ê·œ ì½”ì¹˜ ë“±ë¡"ì—ì„œ ê³„ì •ì„ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.');
    try{ document.querySelector('#loginSection details')?.setAttribute('open',''); }catch(e){}
    updateDebugInfo('DB ì—°ê²°ë¨','ë¡œê·¸ì¸ ì‹¤íŒ¨','ì½”ì¹˜ ì—†ìŒ');
    return;
  }

  const coach=await authCoach(name,pw);
  if(coach){ 
    currentCoach=coach; 
    const coachLabel = document.getElementById('currentCoachName');
    const progressCoachLabel = document.getElementById('progressCoachLabel');
    const notesCoachLabel = document.getElementById('notesCoachLabel');
    if(coachLabel) coachLabel.textContent=coach.name; 
    if(progressCoachLabel) progressCoachLabel.textContent=coach.name;
    if(notesCoachLabel) notesCoachLabel.textContent=coach.name;
    navTo('measurement'); 
    alert(`${coach.name} ì½”ì¹˜ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
  } else {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    updateDebugInfo('DB ì—°ê²°ë¨','ë¡œê·¸ì¸ ì‹¤íŒ¨','ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸');
  }
}

async function handleRegister(){
  const name=document.getElementById('registerCoachName').value.trim();
  const pw=document.getElementById('registerPassword').value;
  const cf=document.getElementById('confirmPassword').value;
  if(!name||!pw||!cf){alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  if(pw.length<4){alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');return;}
  if(pw!==cf){alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  try{
    await registerCoach(name,pw); 
    alert('ì½”ì¹˜ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'); 
    document.getElementById('loginCoachName').value=name; 
    document.getElementById('registerCoachName').value=''; 
    document.getElementById('registerPassword').value=''; 
    document.getElementById('confirmPassword').value='';
  }catch(e){
    alert(e.message||'ë“±ë¡ ì¤‘ ì˜¤ë¥˜');
  }
}

function resetAll(){
  document.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=false);
  document.querySelectorAll('.rating-option').forEach(o=>o.classList.remove('selected'));
  categories.forEach((_,i)=>{const el=document.getElementById(`score_${i}`); if(el) el.textContent=`ì¹´í…Œê³ ë¦¬ ì ìˆ˜: 0/${MAX_PER_CAT}`;});
  ['clientName','gender','age','memberNumber','phone','rhr','heightCm','weightKg'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  updateProgress(); updateResults(); alert('ëª¨ë“  ì…ë ¥ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function logout(){ 
  // 1) ë©”ëª¨ë¦¬ ìƒíƒœ ì´ˆê¸°í™”
  currentCoach = null;
  if (typeof destroyProgressCharts === 'function') { 
    try { destroyProgressCharts(); } catch(e) {}
  }
  if (typeof clearDraft === 'function') {
    try { clearDraft(); } catch(e) {}
  }

  // 2) ì…ë ¥ê°’ ì´ˆê¸°í™” (UI/ë””ìì¸ì€ ê·¸ëŒ€ë¡œ, ê°’ë§Œ ë¹„ì›€)
  const idsToClear = [
    'clientName','memberNumber','gender','age','phone','heightCm','weightKg','rhr',
    'goalNote','goalMemo','measurementDate',
    'progressClientSearch','notesClientSearch'
  ];
  idsToClear.forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.value = ''; }
  });

  // í‘œì‹œ ë¼ë²¨ ì´ˆê¸°í™”(êµ¬ì¡°/ìŠ¤íƒ€ì¼ ë³´ì¡´)
  const labelDefaults = {
    currentCoachName:'-',
    progressCoachLabel:'-',
    notesCoachLabel:'-',
    progressClientLabel:'íšŒì› ì„ íƒ í›„ í™•ì¸',
    notesClientLabel:'íšŒì› ì„ íƒ í›„ í™•ì¸',
    finalTotalScore:'0/300',
    clientDetails:''
  };
  Object.entries(labelDefaults).forEach(([id, val])=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id==='clientDetails'){ el.innerHTML = ''; } else { el.textContent = val; }
  });

  const tbody = document.getElementById('historyTbody');
  if(tbody) tbody.innerHTML = '';

  if (typeof setProgressRange === 'function') { try { setProgressRange(null); } catch(e){} }
  if (typeof renderProgress === 'function') { try { renderProgress(''); } catch(e){} }

  // 3) ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜ (ê¸°ì¡´ CSSê°€ ë‹¤ë¥¸ UIë¥¼ ìˆ¨ê¹€)
  navTo('login'); 
  alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
}

async function handleSave(){
  if(!currentCoach){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');return;}
  const clientName=document.getElementById('clientName').value.trim();
  if(!clientName){alert('ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const {scores,total}=computeScores(); 
  if(total===0){alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸í•­ì— ì‘ë‹µí•´ì£¼ì„¸ìš”.');return;}
  
  const rec={
    date:(document.getElementById('measurementDate').value? new Date(document.getElementById('measurementDate').value):new Date()).toISOString(),
    coachName: currentCoach.name,
    clientName,
    gender: document.getElementById('gender').value||'',
    age: document.getElementById('age').value||'',
    memberNumber: document.getElementById('memberNumber').value||'',
    phone: document.getElementById('phone').value||'',
    rhr: document.getElementById('rhr').value||'',
    heightCm: document.getElementById('heightCm').value||'',
    weightKg: document.getElementById('weightKg').value||'',
    note: (document.getElementById('goalMemo')?.value || document.getElementById('goalNote')?.value || ''),
    scores,
    totalScore: total,
    categoryScores: categories.map((c,i)=>({name:c.name,score:scores[i]}))
  };
  
  try{
    const allClients = await fetchClientsByCoach(currentCoach.name);
    const key = normalizeName(clientName);
    const exact = allClients.find(c=>normalizeName(c.clientName)===key);
    if(exact && exact.clientName!==clientName){
      if(confirm(`ê¸°ì¡´ íšŒì› \'${exact.clientName}\' ê³¼(ì™€) ë™ì¼ì¸ìœ¼ë¡œ í•©ì¹ ê¹Œìš”?`)){
        document.getElementById('clientName').value = exact.clientName;
        rec.clientName = exact.clientName;
      }
    } else {
      const similar = allClients.find(c=>levenshtein(normalizeName(c.clientName), key)<=2);
      if(similar && similar.clientName!==clientName){
        if(confirm(`\'${similar.clientName}\' ê³¼(ì™€) ì´ë¦„ì´ ìœ ì‚¬í•©ë‹ˆë‹¤. ë™ì¼ì¸ìœ¼ë¡œ ì €ì¥í• ê¹Œìš”?`)){
          document.getElementById('clientName').value = similar.clientName;
          rec.clientName = similar.clientName;
        }
      }
    }
    
    await upsertClient(currentCoach.name,{
  clientName,
  memberNumber:rec.memberNumber,
  gender:rec.gender,
  age:rec.age,
  phone:rec.phone,
  heightCm:rec.heightCm,
  // â¬‡ï¸ ì¶”ê°€: ë‹¤ìŒ ë²ˆ ìë™ ì±„ì›€ì— í•„ìš”
  weightKg:rec.weightKg,
  rhr:rec.rhr
});
    await saveRecord(rec);
    alert(`${rec.clientName}ë‹˜ì˜ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    try{ await clearDraft(); }catch(e){}
  }catch(e){ 
    console.error(e); 
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function downloadImage(){
  if(typeof html2canvas==='undefined'){alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
  const el=document.getElementById('resultsSection'); if(!el){alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
  const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2,useCORS:true});
  const link=document.createElement('a'); link.download=`Wellness_ê²°ê³¼_${new Date().toISOString().split('T')[0]}.png`; link.href=canvas.toDataURL(); link.click();
}

async function exportData(){
  if(!currentCoach){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');return;}
  const {scores,total}=computeScores();
  const data={
    exportDate:new Date().toISOString(),
    coachName: currentCoach.name,
    clientName: document.getElementById('clientName')?.value||'',
    measurementDate: document.getElementById('measurementDate')?.value||'',
    totalScore: total,
    categoryScores: categories.map((c,i)=>({category:c.name,score:scores[i],maxScore:MAX_PER_CAT})),
    clientInfo:{
      gender:document.getElementById('gender')?.value||'',
      age:document.getElementById('age')?.value||'',
      memberNumber:document.getElementById('memberNumber')?.value||'',
      phone:document.getElementById('phone')?.value||'',
      rhr:document.getElementById('rhr')?.value||'',
      height:document.getElementById('heightCm')?.value||'',
      weight:document.getElementById('weightKg')?.value||''
    }
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Wellness_ë°ì´í„°_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// ========================
// ì´ˆê¸°í™”
// ========================

// Autosave / Restore
const AUTOSAVE_KEY = () => currentCoach ? currentCoach.name : 'anon';
let autosaveTimer = null;

function collectForm(){
  const ratings = [];
  for(let ci=0; ci<categories.length; ci++){
    const arr=[];
    for(let qi=0; qi<5; qi++){
      const el=document.querySelector(`input[name="q${ci}_${qi}"]:checked`);
      arr.push(el?parseInt(el.value,10):0);
    }
    ratings.push(arr);
  }
  return {
    date: document.getElementById('measurementDate')?.value||'',
    clientName: document.getElementById('clientName')?.value||'',
    memberNumber: document.getElementById('memberNumber')?.value||'',
    gender: document.getElementById('gender')?.value||'',
    age: document.getElementById('age')?.value||'',
    phone: document.getElementById('phone')?.value||'',
    rhr: document.getElementById('rhr')?.value||'',
    heightCm: document.getElementById('heightCm')?.value||'',
    weightKg: document.getElementById('weightKg')?.value||'',
    note: document.getElementById('goalNote')?.value||'',
    ratings
  };
}

function fillForm(d){
  if(!d) return;
  const set = (id,v)=>{const el=document.getElementById(id); if(el) el.value=v||'';}
  set('measurementDate', d.date||'');
  set('clientName', d.clientName||'');
  set('memberNumber', d.memberNumber||'');
  set('gender', d.gender||'');
  set('age', d.age||'');
  set('phone', d.phone||'');
  set('rhr', d.rhr||'');
  set('heightCm', d.heightCm||'');
  set('weightKg', d.weightKg||'');
  set('goalNote', d.note||'');
  
  for(let ci=0; ci<categories.length; ci++){
    for(let qi=0; qi<5; qi++){
      const val = d.ratings?.[ci]?.[qi]||0;
      if(val){
        const input = document.querySelector(`input[name="q${ci}_${qi}"][value="${val}"]`);
        if(input){ input.checked=true; input.dispatchEvent(new Event('change')); }
      }
    }
  }
  updateResults();
}

async function saveDraft(){
  if(!_db) await initDB();
  const key = AUTOSAVE_KEY();
  const data = collectForm();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('drafts','readwrite');
    const st=tx.objectStore('drafts');
    const r=st.put({key, data, savedAt:new Date().toISOString()});
    r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
  });
}

async function loadDraft(){
  if(!_db) await initDB();
  const key = AUTOSAVE_KEY();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('drafts','readonly');
    const st=tx.objectStore('drafts');
    const r=st.get(key);
    r.onsuccess=()=>res(r.result?.data||null); r.onerror=()=>rej(r.error);
  });
}

async function clearDraft(){
  if(!_db) await initDB();
  const key = AUTOSAVE_KEY();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('drafts','readwrite');
    const st=tx.objectStore('drafts');
    const r=st.delete(key);
    r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
  });
}

function scheduleAutosave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{ saveDraft().catch(()=>{}); }, 800);
}

async function countCoaches(){
  if(!_db) await initDB();
  return new Promise((res,rej)=>{
    const tx=_db.transaction('coaches','readonly');
    const st=tx.objectStore('coaches');
    const rq=st.count();
    rq.onsuccess=()=>res(rq.result||0);
    rq.onerror=()=>rej(rq.error);
  });
}

async function initApp(){
  try{
    await initDB();
    const today=new Date().toISOString().split('T')[0];
    const dateInput=document.getElementById('measurementDate'); 
    if(dateInput) dateInput.value=today;
    renderCategories();
    document.body.dataset.view='login';
    navTo('login');
    
    countCoaches().then(n=>{ 
      if(n===0){ 
        document.querySelector('#loginSection details')?.setAttribute('open',''); 
      } 
    }).catch(()=>{});

    // Autosave events
    ['measurementDate','clientName','memberNumber','gender','age','phone','rhr','heightCm','weightKg','goalNote'].forEach(id=>{
      const el=document.getElementById(id); 
      if(el){ el.addEventListener('input', scheduleAutosave); }
    });
    
    document.body.addEventListener('change', (e)=>{ 
      if(e.target && e.target.type==='radio'){ scheduleAutosave(); } 
    });

    document.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){
        if(currentView==='login'){
          const ae=document.activeElement;
          if(ae&&ae.id==='loginPassword') handleLogin();
          else if(ae&&ae.id==='confirmPassword') handleRegister();
        }
      }
    });

    window.addEventListener('beforeunload',(e)=>{
      if(currentView==='measurement'){
        const answered=document.querySelectorAll('.rating-scale input:checked').length;
        if(answered>0){ 
          e.preventDefault(); 
          e.returnValue='ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?'; 
          return e.returnValue;
        }
      }
    });
  }catch(e){
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨',e); 
    alert('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message);
  }
}

document.addEventListener('DOMContentLoaded',initApp);
window.addEventListener('error',(e)=>{updateDebugInfo('DB ìƒíƒœ ë¶ˆëª…','ì•± ì˜¤ë¥˜',e.error?.message||'JS ì˜¤ë¥˜');});
window.addEventListener('unhandledrejection',(e)=>{updateDebugInfo('DB ìƒíƒœ ë¶ˆëª…','ì•± ì˜¤ë¥˜',e.reason?.message||'Promise ì˜¤ë¥˜');});

// ì§„í–‰ë¥  ì›í˜• í‘œì‹œ ì œì–´
function updateFloatingProgress(pct){
  let fp=document.getElementById('floatingProgress');
  if(!fp&&pct>0){
    fp=document.createElement('div');
    fp.id='floatingProgress';
    fp.className='floating-progress';
    fp.innerHTML=`<div class="progress-circle"><div class="progress-number">0%</div></div><div class="progress-label">ì‘ë‹µë¥ </div>`;
    document.body.appendChild(fp);
  }
  if(fp){
    const circle=fp.querySelector('.progress-circle');
    const number=fp.querySelector('.progress-number');
    const deg=(pct/100)*360;
    circle.style.background=`conic-gradient(#4facfe ${deg}deg,#e9ecef ${deg}deg)`;
    number.textContent=`${pct}%`; 
    fp.style.display=pct>0?'block':'none';
  }
}

const showFloatingProgress=()=>{
  const fp=document.getElementById('floatingProgress'); 
  if(fp) fp.style.display='block';
}

const hideFloatingProgress=()=>{
  const fp=document.getElementById('floatingProgress'); 
  if(fp) fp.style.display='none';
}

/* ===== ê²°ê³¼ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ: 4ê°œ íŒ¨ë„ì„ í•œ ì¥ìœ¼ë¡œ í•©ì³ ì €ì¥ ===== */
async function _cap(el) {
  return await html2canvas(el, { backgroundColor:'#ffffff', scale:2, useCORS:true });
}

async function downloadCombinedResults(panelIds = [
  'resultRadarPanel',      // ë ˆì´ë”ì°¨íŠ¸
  'resultInfoPanel',       // ì¸¡ì •ì •ë³´
  'resultCategoryPanel',   // ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ì ìˆ˜
  'resultsTrendPanel'      // ê°œì¸ ì ìˆ˜ ì¶”ì´
]) {
  const [radarEl, infoEl, catEl, trendEl] = panelIds.map(id => document.getElementById(id));
  if (!(radarEl && infoEl && catEl && trendEl)) {
    alert('ê²°ê³¼ íŒ¨ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒ¨ë„ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    return;
  }

  // 1) ê° íŒ¨ë„ ìº¡ì²˜
  const [cRadar, cInfo, cCat, cTrend] = await Promise.all([radarEl, infoEl, catEl, trendEl].map(_cap));

  const gap = 24;

  // 2) í–‰ë³„ í¬ê¸° ê³„ì‚°
  const row1Width  = cRadar.width + gap + cInfo.width;
  const row1Height = Math.max(cRadar.height, cInfo.height);

  const outWidth  = Math.max(row1Width, cCat.width, cTrend.width);
  const outHeight = row1Height + gap + cCat.height + gap + cTrend.height;

  // 3) í•©ì„± ìº”ë²„ìŠ¤
  const out = document.createElement('canvas');
  out.width  = outWidth;
  out.height = outHeight;
  const ctx = out.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, out.width, out.height);

  // 4) ê·¸ë¦¬ê¸° â€” í–‰ë§ˆë‹¤ ê°€ìš´ë° ì •ë ¬
  // í–‰ 1: ë ˆì´ë” | ì¸¡ì •ì •ë³´ (ì¢Œìš°)
  {
    const startX = Math.round((outWidth - row1Width) / 2);
    const y = 0;
    ctx.drawImage(cRadar, startX, y);
    ctx.drawImage(cInfo,  startX + cRadar.width + gap, y);
  }

  // í–‰ 2: ì¹´í…Œê³ ë¦¬(ì „ì²´í­)
  {
    const startX = Math.round((outWidth - cCat.width) / 2);
    const y = row1Height + gap;
    ctx.drawImage(cCat, startX, y);
  }

  // í–‰ 3: ê°œì¸ ì¶”ì´(ì „ì²´í­)
  {
    const startX = Math.round((outWidth - cTrend.width) / 2);
    const y = row1Height + gap + cCat.height + gap;
    ctx.drawImage(cTrend, startX, y);
  }

  // 5) ë‹¤ìš´ë¡œë“œ
  const a = document.createElement('a');
  a.download = `Owellness_ê²°ê³¼_${new Date().toISOString().slice(0,10)}.png`;
  a.href = out.toDataURL('image/png');
  a.click();
}
</script>
</body>
</html>